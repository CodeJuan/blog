<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Continuous Learning</title>
  <subtitle>浮云一别后，流水十年间</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.decbug.com/"/>
  <updated>2016-10-17T00:03:31.866Z</updated>
  <id>http://blog.decbug.com/</id>
  
  <author>
    <name>CodeJuan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>调用链技术分析</title>
    <link href="http://blog.decbug.com/2016/10/14/tracing/"/>
    <id>http://blog.decbug.com/2016/10/14/tracing/</id>
    <published>2016-10-13T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://cloud.githubusercontent.com/assets/5423628/19371598/083f6f56-91e7-11e6-8964-63f4780885f1.png" alt="分布式调用"></p>
<p>都源于google的dapper，常见的有三种方式</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>概要</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>自己打日志</td>
<td>请求进入时生成ID，每次跨节点调用都带上ID，日志也打上ID</td>
<td>自己实现（这个算不算优点）</td>
<td>麻烦</td>
</tr>
<tr>
<td>用开源库，如zipkin</td>
<td>原理都差不多，都是ID spanID parentID</td>
<td>简单，client和server都有例子</td>
<td>需要集成</td>
</tr>
<tr>
<td>改分布式框架，如鹰眼，京东改dubbo</td>
<td>不用侵入业务代码，在框架里做好埋点和日志</td>
<td>自己实现</td>
<td>稍微麻烦，需要自己改框架</td>
</tr>
<tr>
<td>运行环境注入</td>
<td>例如<a href="https://newrelic.com/" target="_blank" rel="external">newrelic</a>，<a href="https://github.com/naver/pinpoint" target="_blank" rel="external">pinpoint</a>，改JVM运行时bytecode</td>
<td>非侵入</td>
<td>性能损耗比较大</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h1 id="dapper论文"><a href="#dapper论文" class="headerlink" title="dapper论文"></a>dapper论文</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/19371479/05ebe2b2-91e6-11e6-9a89-9827415d9464.png" alt="image"></p>
<p><img src="https://cloud.githubusercontent.com/assets/5423628/19371503/288995bc-91e6-11e6-9e68-8b198725a8a8.png" alt="image"></p>
<p><img src="https://cloud.githubusercontent.com/assets/5423628/19371519/3f05e1e2-91e6-11e6-84cf-77c2f095ff74.png" alt="image"></p>
<h1 id="zipkin"><a href="#zipkin" class="headerlink" title="zipkin"></a>zipkin</h1><p>在公司体验了一下，流程和<a href="https://yq.aliyun.com/articles/60165?spm=5176.100244.teamconlist.33.wxgYuD" target="_blank" rel="external">https://yq.aliyun.com/articles/60165?spm=5176.100244.teamconlist.33.wxgYuD</a><br>差不多</p>
<h1 id="改造分布式框架"><a href="#改造分布式框架" class="headerlink" title="改造分布式框架"></a>改造分布式框架</h1><p>在发远程调用，收到远程调用的时候，框架自身记录下来<br>实现起来想必不容易，但收益很大</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/5423628/19371598/083f6f56-91e7-11e6-8964-63f4780885f1.png&quot; alt=&quot;分布式调用&quot;&gt;&lt;/p&gt;
&lt;p&gt;都源于google的dapper，常见的有三种方式&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;名称&lt;/th&gt;
&lt;th&gt;概要&lt;/th&gt;
&lt;th&gt;优点&lt;/th&gt;
&lt;th&gt;缺点&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;自己打日志&lt;/td&gt;
&lt;td&gt;请求进入时生成ID，每次跨节点调用都带上ID，日志也打上ID&lt;/td&gt;
&lt;td&gt;自己实现（这个算不算优点）&lt;/td&gt;
&lt;td&gt;麻烦&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;用开源库，如zipkin&lt;/td&gt;
&lt;td&gt;原理都差不多，都是ID spanID parentID&lt;/td&gt;
&lt;td&gt;简单，client和server都有例子&lt;/td&gt;
&lt;td&gt;需要集成&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;改分布式框架，如鹰眼，京东改dubbo&lt;/td&gt;
&lt;td&gt;不用侵入业务代码，在框架里做好埋点和日志&lt;/td&gt;
&lt;td&gt;自己实现&lt;/td&gt;
&lt;td&gt;稍微麻烦，需要自己改框架&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;运行环境注入&lt;/td&gt;
&lt;td&gt;例如&lt;a href=&quot;https://newrelic.com/&quot;&gt;newrelic&lt;/a&gt;，&lt;a href=&quot;https://github.com/naver/pinpoint&quot;&gt;pinpoint&lt;/a&gt;，改JVM运行时bytecode&lt;/td&gt;
&lt;td&gt;非侵入&lt;/td&gt;
&lt;td&gt;性能损耗比较大&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="APM" scheme="http://blog.decbug.com/tags/APM/"/>
    
  </entry>
  
  <entry>
    <title>sysdig源码分析</title>
    <link href="http://blog.decbug.com/2016/10/12/sysdig/"/>
    <id>http://blog.decbug.com/2016/10/12/sysdig/</id>
    <published>2016-10-11T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<p>之前分析APM的时候，试用了sysdig，觉得sysdig很厉害</p>
<ol>
<li>通过内核抓事件，不用侵入到容器</li>
<li>可以自己写铲子，扩展起来很方便。<br>于是就顺手看下他的实现原理</li>
</ol>
<a id="more"></a>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p><a href="https://github.com/draios/sysdig" target="_blank" rel="external">https://github.com/draios/sysdig</a></p>
<h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><img src="http://www.plantuml.com/plantuml/svg/NOzB3i8m34JtFOML1MgHk0Ai4E8C1Q7G3gs5vQ8wV4zFa_8JondRyyRvjA3PR4vkhHpO2pzyu4vTbYNNxbPpGpqQje2US866zx1gsI2vd7r1dUvuIDWe6SBkm1At9qcO-fCWHevdH_GA-KJnWTorPG6j49RHN3WABJGZYjNAEsmxmBp8tbT7gbmQp7-jLEJh9nahlHXZq3yPOiZYHQdT0C2DNv-LIwrP6phrNGKRuFcqU080">
<h1 id="chisels的原理"><a href="#chisels的原理" class="headerlink" title="chisels的原理"></a>chisels的原理</h1><p>安装之后会在/usr/share/sysdig/chisels，看下memcachelog这个铲子的代码<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Initialization callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">on_init</span><span class="params">()</span></span></span><br><span class="line">    util = &#123;&#125;</span><br><span class="line">    start_time = <span class="built_in">os</span>.time()</span><br><span class="line">    sysdig.set_filter(<span class="string">"(fd.sport=11211 or proc.name=memcached) and evt.is_io=true"</span>)</span><br><span class="line">    sysdig.set_snaplen(<span class="number">4096</span>)</span><br><span class="line">    data = chisel.request_field(<span class="string">"evt.arg[1]"</span>)</span><br><span class="line">    datetime = chisel.request_field(<span class="string">"evt.datetime"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Event callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">on_event</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> data = evt.field(data)</span><br><span class="line">  <span class="keyword">local</span> line = split(data, <span class="string">" "</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">string</span>.match(line[<span class="number">1</span>], <span class="string">'^[gs]et'</span>) ~= <span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> method = line[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">local</span> key = line[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">local</span> size = <span class="built_in">tonumber</span>(line[<span class="number">5</span>]) <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> key ~= <span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> opt_method ~= <span class="keyword">nil</span> <span class="keyword">and</span> opt_method ~= method <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span> opt_method == <span class="string">'set'</span> <span class="keyword">and</span> size &lt; opt_size <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="built_in">print</span>(<span class="built_in">string</span>.format(<span class="string">"%s method=%s size=%dB key=%s"</span>,</span><br><span class="line">              evt.field(datetime),</span><br><span class="line">              method,</span><br><span class="line">              size,</span><br><span class="line">              key</span><br><span class="line">      ))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>on_init 设置filter，以及需要哪些data field</p>
<p>on_event，获取参数，得到method，是get/set，以及key</p>
<h1 id="sysdig原理"><a href="#sysdig原理" class="headerlink" title="sysdig原理"></a>sysdig原理</h1><p><code>driver/event_table.c</code> 事件都在这里g_event_info</p>
<p><code>driver/ppm_fillers.c</code> g_ppm_events事件的回调</p>
<p><code>userspace/libsinsp/chisel_api.cpp</code> lua_cbacks这个类是，lua调用c代码的接口</p>
<p>疑问：</p>
<ol>
<li>当事件发生，如何通过g_ppm_events里的回调函数再调用到lua里的on_event</li>
<li>event_table里的事件是如何发送到内核的？用到哪个API？是不是和systemtap差不多？</li>
</ol>
<p>晚上回家继续看看</p>
<h2 id="event-table里的事件是如何发送到内核的"><a href="#event-table里的事件是如何发送到内核的" class="headerlink" title="event_table里的事件是如何发送到内核的"></a>event_table里的事件是如何发送到内核的</h2><p>event_table里的事件是如何发送到内核的？用到哪个API？是不是和systemtap差不多？<br>翻了下源码，终于找到了<br>sysdig_init-&gt;get_tracepoint_handler-&gt;g_ppm_fops-&gt;ppm_open-&gt;compat_register-&gt;TRACEPOINT_PROBE_REGISTER-&gt;内核的tracepoint_probe_register</p>
<p>两个参数，一个是tracepoint name,另一个则是回调</p>
<h1 id="slideshare上的流程"><a href="#slideshare上的流程" class="headerlink" title="slideshare上的流程"></a>slideshare上的流程</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/19371219/091e8342-91e4-11e6-8a53-f2e597860efb.png" alt="syscall"></p>
<p><img src="https://cloud.githubusercontent.com/assets/5423628/19371250/40b1dd72-91e4-11e6-97c8-29ac829afde8.png" alt="event_collector"></p>
<p><img src="https://cloud.githubusercontent.com/assets/5423628/19371280/6b0da6be-91e4-11e6-9c9b-77b151f8428c.png" alt="container"></p>
<p><a href="http://www.slideshare.net/SreenivasMakam/container-monitoring-with-sysdig-58790785" target="_blank" rel="external">http://www.slideshare.net/SreenivasMakam/container-monitoring-with-sysdig-58790785</a></p>
<p><a href="http://www.slideshare.net/Sysdig/sysdig-meetup-dec2014" target="_blank" rel="external">http://www.slideshare.net/Sysdig/sysdig-meetup-dec2014</a></p>
<h1 id="其他内核trace"><a href="#其他内核trace" class="headerlink" title="其他内核trace"></a>其他内核trace</h1><table>
<thead>
<tr>
<th>时间</th>
<th>名字</th>
<th>主要技术</th>
</tr>
</thead>
<tbody>
<tr>
<td>2000</td>
<td>Linux Trace Toolkit (LTT)</td>
<td></td>
</tr>
<tr>
<td>2005</td>
<td>LInux Trace Toolkit Next Generation (LTTng)</td>
<td></td>
</tr>
<tr>
<td>2008</td>
<td>Tracepoint</td>
<td>后面就用这个比较多？</td>
</tr>
<tr>
<td>xxxx</td>
<td>systemTAP</td>
<td>貌似也是用tracepoint probe</td>
</tr>
<tr>
<td>xxxx</td>
<td>ftrace</td>
<td>也是tracepoint</td>
</tr>
</tbody>
</table>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前分析APM的时候，试用了sysdig，觉得sysdig很厉害&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过内核抓事件，不用侵入到容器&lt;/li&gt;
&lt;li&gt;可以自己写铲子，扩展起来很方便。&lt;br&gt;于是就顺手看下他的实现原理&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="APM" scheme="http://blog.decbug.com/tags/APM/"/>
    
  </entry>
  
  <entry>
    <title>容器分布式存储之Flocker</title>
    <link href="http://blog.decbug.com/2016/10/10/Flocker/"/>
    <id>http://blog.decbug.com/2016/10/10/Flocker/</id>
    <published>2016-10-09T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<p>容器的分布式存储都差不多，都是docker daemon-&gt;plugin-&gt;agent-&gt;control，话说cinder也差不多。<br>正好看到了flocker，简单了解一下架构，记录下来加深印象</p>
<a id="more"></a>
<h1 id="flocker"><a href="#flocker" class="headerlink" title="flocker"></a>flocker</h1><p><img src="https://uploads.disquscdn.com/images/b891c982b375e67d8f6e22030c0404e86e3ea54c2f086be24e54dbd921d62e97.png" alt=""></p>
<h1 id="手绘架构图"><a href="#手绘架构图" class="headerlink" title="手绘架构图"></a>手绘架构图</h1><p><img src="https://uploads.disquscdn.com/images/edf315d6c61c5b6ef839fbd8513ebb7969f91d36d87984062f9a779601ba0e10.jpg" alt=""></p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;容器的分布式存储都差不多，都是docker daemon-&amp;gt;plugin-&amp;gt;agent-&amp;gt;control，话说cinder也差不多。&lt;br&gt;正好看到了flocker，简单了解一下架构，记录下来加深印象&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="distributed storage" scheme="http://blog.decbug.com/tags/distributed-storage/"/>
    
  </entry>
  
  <entry>
    <title>APM厂商分析</title>
    <link href="http://blog.decbug.com/2016/10/10/APM/"/>
    <id>http://blog.decbug.com/2016/10/10/APM/</id>
    <published>2016-10-09T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<p>在微服务大行其道的今天，系统的实例越来越多，出现性能问题时要调试就很困难。于是乎，就出现了许多APM厂商，只需要装一个agent，就能通过监控系统调用，网络传输，性能指标，辅助调试定位性能问题。</p>
<p>在公司分析了很多，也抓包了，详细内容带不出来。就简单记个笔记，供以后回忆</p>
<a id="more"></a>
<h1 id="sysdig"><a href="#sysdig" class="headerlink" title="sysdig"></a>sysdig</h1><p>分为<a href="https://github.com/draios/sysdig" target="_blank" rel="external">开源版sysdig.org</a>和<a href="https://sysdig.com/" target="_blank" rel="external">商业版sysdig cloud</a></p>
<h2 id="开源"><a href="#开源" class="headerlink" title="开源"></a>开源</h2><p>原理：抓内核级别的调用，比如read，write，网络也是read，write，只不过描述符不一样，然后形成事件，记录下来<br>还有个强大的功能Chisel，很好玩，可以自己扩展功能，用lua写<br><a href="https://github.com/draios/sysdig/wiki/Writing-a-Sysdig-Chisel,-a-Tutorial" target="_blank" rel="external">Writing a Sysdig Chisel, a Tutorial</a></p>
<h2 id="sysdig-cloud"><a href="#sysdig-cloud" class="headerlink" title="sysdig cloud"></a>sysdig cloud</h2><p>装一个agent，用的是开源的sysdig采集数据，然后上报到sysdig cloud的服务器。</p>
<ul>
<li>可以展示topo，调用耗时等等</li>
<li>分析http，可以精确到url</li>
<li>通过分析开源代码，分析出具体的调用，原理应该和chisel中的memcache差不多</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>dynatrace &amp; apptrace<br>都差不多</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在微服务大行其道的今天，系统的实例越来越多，出现性能问题时要调试就很困难。于是乎，就出现了许多APM厂商，只需要装一个agent，就能通过监控系统调用，网络传输，性能指标，辅助调试定位性能问题。&lt;/p&gt;
&lt;p&gt;在公司分析了很多，也抓包了，详细内容带不出来。就简单记个笔记，供以后回忆&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="APM" scheme="http://blog.decbug.com/tags/APM/"/>
    
  </entry>
  
  <entry>
    <title>VxLan原理</title>
    <link href="http://blog.decbug.com/2016/10/09/VxLan/"/>
    <id>http://blog.decbug.com/2016/10/09/VxLan/</id>
    <published>2016-10-08T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<p>VxLan，网络虚拟化，应用很广泛</p>
<p>简单记录一下原理</p>
<a id="more"></a>
<p><img src="http://www.aboutyun.com/data/attachment/forum/201501/12/200932g95t3x5zlllv0cn3.jpg" alt="Frame Format"></p>
<p><img src="http://www.aboutyun.com/data/attachment/forum/201501/12/201142n2mmll72er7pldlp.jpg" alt=""></p>
<ol>
<li>VM1发送IP数据包到VM2，即192.168.0.100 到 192.168.0.101；</li>
<li>VTEP1查找自己的VXLAN表知道要发给VTEP2，然后依次封装以下数据包头；<ul>
<li>VXLAN包头</li>
<li>标准UDP包头，校验和checksum为0x0000；</li>
<li>标准IP包头，目标地址为VTEP2的IP地址，协议号设为0x11表面为UDP包。</li>
<li>标准MAC数据包，目标地址为下一跳设备的MAC地址00:10:11:FE:D8:D2，可路由到目标隧道端VTEP2。</li>
</ul>
</li>
<li>VTEP2接收数据包，根据UDP的destination端口找到VXLAN数据包。接着查找所有所在VXLAN的VNI为864的端口组，找到VM2的</li>
<li>VM2接收并处理数据包，拿到Payload数据。</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://www.aboutyun.com/thread-11189-1-1.html" target="_blank" rel="external">http://www.aboutyun.com/thread-11189-1-1.html</a></p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;VxLan，网络虚拟化，应用很广泛&lt;/p&gt;
&lt;p&gt;简单记录一下原理&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="VxLan" scheme="http://blog.decbug.com/tags/VxLan/"/>
    
  </entry>
  
  <entry>
    <title>分布式系统调度算法的公平</title>
    <link href="http://blog.decbug.com/2016/09/30/scheduler_fair/"/>
    <id>http://blog.decbug.com/2016/09/30/scheduler_fair/</id>
    <published>2016-09-29T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<p>调度，在计算机世界里随处可见，只要有资源抢占，就需要调度。</p>
<p><img src="http://a3.att.hudong.com/78/47/01300000763638128366476399672.jpg" alt="无调度"></p>
<p><img src="http://img.www.zyue.com/news/2011/04/06/201104060829106892011040202.jpg" alt="有调度"></p>
<a id="more"></a>
<h1 id="CFS"><a href="#CFS" class="headerlink" title="CFS"></a>CFS</h1><p>操作系统要调度一堆进程，也是离不开调度算法的，linux喜欢用CFS，这里可以稍微扩展记录一下，加深印象</p>
<h1 id="分布式系统的调度"><a href="#分布式系统的调度" class="headerlink" title="分布式系统的调度"></a>分布式系统的调度</h1><p>公平与不公平<br>所谓公平，就是人人有饭吃，不能有人饿死</p>
<h2 id="不公平"><a href="#不公平" class="headerlink" title="不公平"></a>不公平</h2><ul>
<li>job1先来，job1有很多个task，就开始执行job1的task</li>
<li>之后job2过来，但是job1的task还没执行完，那么job2就要一直等待，这就叫饥饿</li>
</ul>
<h2 id="公平"><a href="#公平" class="headerlink" title="公平"></a>公平</h2><p>公平就是，大家都有饭吃</p>
<ul>
<li>job1先来，job1有很多个task，开始执行job1的task</li>
<li>然后job2过来，这时候job1的task还有一些没有执行完</li>
<li>调度器就会block job1，也就是说，会把job1剩余的task挂起</li>
<li>开始执行job2的task</li>
<li>一段时间后，由于job1饥饿了，所以又把job2 block，执行job1的task</li>
</ul>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;调度，在计算机世界里随处可见，只要有资源抢占，就需要调度。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://a3.att.hudong.com/78/47/01300000763638128366476399672.jpg&quot; alt=&quot;无调度&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.www.zyue.com/news/2011/04/06/201104060829106892011040202.jpg&quot; alt=&quot;有调度&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="fair" scheme="http://blog.decbug.com/tags/fair/"/>
    
      <category term="scheduler" scheme="http://blog.decbug.com/tags/scheduler/"/>
    
  </entry>
  
  <entry>
    <title>TCPIP ping ssh</title>
    <link href="http://blog.decbug.com/2016/09/09/ping_ssh/"/>
    <id>http://blog.decbug.com/2016/09/09/ping_ssh/</id>
    <published>2016-09-08T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<p>数据库部署在k8s上，两个pod一主一备，却无法同步，一直同步失败，提示socket 什么什么什么。据同事说，还有一个现象是ping都会报错</p>
<a id="more"></a>
<h1 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h1><p>我看了下ping的报错,说permission啥啥啥的，于是谷歌一下，找到答案。是因为权限问题，用<strong>chmod u+s /bin/ping</strong>解决。</p>
<h1 id="能ping通，为何还是传输有问题"><a href="#能ping通，为何还是传输有问题" class="headerlink" title="能ping通，为何还是传输有问题"></a>能ping通，为何还是传输有问题</h1><p>因为ping是ICMP协议，基于IP层，能ping说，说明IP层是好的，无法确定TCP正常</p>
<h1 id="尝试用SSH测试TCP是否正常"><a href="#尝试用SSH测试TCP是否正常" class="headerlink" title="尝试用SSH测试TCP是否正常"></a>尝试用SSH测试TCP是否正常</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ssh -vvv [ip]</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 返回</span></span><br><span class="line">debug1: Connection established.</span><br><span class="line"></span><br><span class="line">debug1: Local version <span class="built_in">string</span> SSH-<span class="number">2.0</span>-OpenSSH_6<span class="number">.6</span><span class="number">.1</span>p1 Ubuntu-<span class="number">2u</span>buntu2<span class="number">.8</span></span><br><span class="line">debug1: Remote protocol version <span class="number">2.0</span>, remote software version OpenSSH_6<span class="number">.6</span><span class="number">.1</span>p1 Ubuntu-<span class="number">2u</span>buntu2</span><br><span class="line">debug1: match: OpenSSH_6<span class="number">.6</span><span class="number">.1</span>p1 Ubuntu-<span class="number">2u</span>buntu2 pat OpenSSH_6<span class="number">.6</span><span class="number">.1</span>* compat <span class="number">0x04000000</span></span><br><span class="line"></span><br><span class="line">debug1: SSH2_MSG_KEXINIT sent</span><br></pre></td></tr></table></figure>
<ol>
<li>在<code>SSH2_MSG_KEXINIT</code>之后就没有了响应，</li>
<li><code>debug1: Connection established.</code>说明tcp连接建立成功</li>
<li>版本协商<ul>
<li><code>debug1: Local version string SSH-2.0-OpenSSH_6.6.1p1 Ubuntu-2ubuntu2.8</code>，本地ssh版本</li>
<li><code>debug1: Remote protocol version 2.0, remote software version OpenSSH_6.6.1p1 Ubuntu-2ubuntu2</code>，远端版本</li>
<li><code>debug1: match: OpenSSH_6.6.1p1 Ubuntu-2ubuntu2 pat OpenSSH_6.6.1* compat 0x04000000</code></li>
<li>说明成功通信一次</li>
</ul>
</li>
<li><code>debug1: SSH2_MSG_KEXINIT sent</code>，开始进行key的协商，然后就没有然后了</li>
</ol>
<p>后面的定位过程，就涉及到容器组网方案，不适合公开。</p>
<h1 id="顺便理解一下SSH协议"><a href="#顺便理解一下SSH协议" class="headerlink" title="顺便理解一下SSH协议"></a>顺便理解一下SSH协议</h1><p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/ssh/capture.png" alt="capture"></p>
<ol>
<li>6,7,8握手</li>
<li>9,11协议协商阶段</li>
<li>16，17,20,23,24交换密钥阶段</li>
<li>认证阶段</li>
<li>会话</li>
</ol>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;数据库部署在k8s上，两个pod一主一备，却无法同步，一直同步失败，提示socket 什么什么什么。据同事说，还有一个现象是ping都会报错&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="TCPIP" scheme="http://blog.decbug.com/tags/TCPIP/"/>
    
      <category term="protocol" scheme="http://blog.decbug.com/tags/protocol/"/>
    
  </entry>
  
  <entry>
    <title>随手记录DHCP</title>
    <link href="http://blog.decbug.com/2016/08/29/dhcp/"/>
    <id>http://blog.decbug.com/2016/08/29/dhcp/</id>
    <published>2016-08-28T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<p>同事用PXE装系统，在装完最小系统后，会再次获取IP，然而DHCP却给了一个不一样的IP</p>
<a id="more"></a>
<h1 id="网上别人抓的正常包"><a href="#网上别人抓的正常包" class="headerlink" title="网上别人抓的正常包"></a>网上别人抓的正常包</h1><p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/dhcp/pxe_dhcp_normal.jpg" alt="get"><br>可以看到</p>
<ol>
<li>装miniOS之前Discover,offer,request,ack</li>
<li>完成miniOS之后，request,ack</li>
</ol>
<h1 id="同事抓的包"><a href="#同事抓的包" class="headerlink" title="同事抓的包"></a>同事抓的包</h1><p>没有办法带出公司，只能凭记忆</p>
<ol>
<li>装miniOS之前Discover,offer,request,ack</li>
<li>完成miniOS之后，<strong>Discover,offer</strong>,request,ack</li>
<li>由于Discover了两次，所以得到了两个IP</li>
</ol>
<h1 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h1><p>为什么会Discoverr两次？即使是Discover两次，那么对于同一个mac，DHCP也应该分配同样的IP吧？<br>DHCP的配置里有一个忽略clientID的参数</p>
<h1 id="复习DHCP流程"><a href="#复习DHCP流程" class="headerlink" title="复习DHCP流程"></a>复习DHCP流程</h1><p><img src="http://s3.51cto.com/wyfs02/M02/7B/63/wKioL1bM12-TVB73AAKfYIzxVJg695.png" alt=""></p>
<blockquote>
<p>参考<a href="http://tasnrh.blog.51cto.com/4141731/1744495" target="_blank" rel="external">http://tasnrh.blog.51cto.com/4141731/1744495</a><br><strong>DHCP发现（DISCOVER）</strong><br>目标设备在物理子网上发送广播来寻找可用的服务器。网络管理员可以配置一个本地路由来转发DHCP包给另一个子网上的DHCP服务器。该目标设备实现生成一个目的地址为255.255.255.255或者一个子网广播地址的UDP包。<br><strong>DHCP提供（OFFER）</strong><br>当DHCP服务器收到一个来自目标设备的IP租约请求时，它会提供一个IP租约。DHCP为目标设备保留一个IP地址，然后通过网络单播一个DHCPOFFER消息给目标设备。该消息包含目标设备的MAC地址、服务器提供的IP地址、子网掩码、租期以及提供IP的DHCP服务器的IP。<br>服务器基于在CHADDR字段指定的目标设备硬件地址来检查配置。这里的服务器，10.1.1.1，将IP地址指定于YIADDR字段。<br><strong>DHCP请求（REQUEST）</strong><br>当目标设备PC收到一个IP租约提供时，它必须告诉所有其他的DHCP服务器它已经接受了一个租约提供。因此，该目标设备会发送一个DHCPREQUEST消息，其中包含提供租约的服务器的IP。当其他DHCP服务器收到了该消息后，它们会收回所有可能已提供给目标设备的租约。然后它们把曾经给目标设备保留的那个地址重新放回到可用地址池中，这样，它们就可以为其他计算机分配这个地址。任意数量的DHCP服务器都可以响应同一个IP租约请求，但是每一个目标设备网卡只能接受一个租约提供。<br><strong>DHCP确认（Acknowledge，ACK）</strong><br>当DHCP服务器收到来自目标设备的REQUEST消息后，它就开始了配置过程的最后阶段。这个响应阶段包括发送一个DHCPACK包给目标设备。这个包包含租期和目标设备可能请求的其他所有配置信息。这时候，TCP/IP配置过程就完成了。</p>
</blockquote>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;同事用PXE装系统，在装完最小系统后，会再次获取IP，然而DHCP却给了一个不一样的IP&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="DHCP" scheme="http://blog.decbug.com/tags/DHCP/"/>
    
      <category term="wireshark" scheme="http://blog.decbug.com/tags/wireshark/"/>
    
  </entry>
  
  <entry>
    <title>通过故事谈消息队列</title>
    <link href="http://blog.decbug.com/2016/08/23/sth_about_MQ/"/>
    <id>http://blog.decbug.com/2016/08/23/sth_about_MQ/</id>
    <published>2016-08-22T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<p>通过简单的例子，讲故事的方式解释消息队列</p>
<a id="more"></a>
<p>我们在做架构设计的时候，我个人理解，有一点很重要，叫各司其职。<br>如何才算各司其职呢？首先，你得让他们各自有职责，才有职可依。<br>比如说，举个不恰当的例子，以前没有数据库的时候，我们要吧数据持久化，可能需要自己写文件，自己写查找算法。后面大家觉得自己存取数据太麻烦，而且不通用，于是就想办法专门做一个模块来存取数据。<br>这个，就是职责划分产生的必然结果。</p>
<p>故事</p>
<ul>
<li>在很久很久以前，人们住得很近，所谓鸡犬之声相闻，邻居之间有个啥事需要帮忙，吼一声，大家都能听到，就会帮你做事。</li>
<li>再后来，村庄变城市，大家住的越来越远，家庭的独立性越来越强，相互之间再通过吼一声来已然不现实，所以，就有了电话。想让对方帮忙，足不出户，一个电话就能通知到。</li>
<li>但是，你想要对方帮忙，还得知道电话号码，如果换号码了也没有通知到你，那么你就无法找对方帮忙了。于是乎，就出了信使这个职业。你只要告诉信使，你需要人来做某某事，信使就会把你的任务通知到所有能做这个事的人。收到任务的人，就会去做，做完之后他就告诉信使已完成，信使再告诉你结果。</li>
</ul>
<p>对应到计算机世界</p>
<ul>
<li>在同一个进程，想调用别人，知道接口就行。对应的是村庄时代</li>
<li>再后来，单机性能不够，所以，就需要拆分到多个机器。比如，数据库就部署到单独的机器，别人通过远程调用来使用。对应的是电话时代</li>
<li>再后来，集群时代到来，于是消息队列就红红火火恍恍惚惚。对应信使时代</li>
</ul>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通过简单的例子，讲故事的方式解释消息队列&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="MQ" scheme="http://blog.decbug.com/tags/MQ/"/>
    
  </entry>
  
  <entry>
    <title>Docker基础知识--namespace cgroup</title>
    <link href="http://blog.decbug.com/2016/08/15/docker_basic/"/>
    <id>http://blog.decbug.com/2016/08/15/docker_basic/</id>
    <published>2016-08-14T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<p>记录一下docker基础知识</p>
<p>namespace是环境隔离，cgroup是资源隔离，加起来就是docker的基础</p>
<a id="more"></a>
<h1 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h1><ol>
<li>CLONE_NEWPID</li>
<li>CLONE_NEWUTS</li>
<li>CLONE_NEWNS</li>
<li>CLONE_NEWIPC</li>
<li>CLONE_NEWNET</li>
<li>CLONE_NEWUSER</li>
</ol>
<h2 id="不带namespace"><a href="#不带namespace" class="headerlink" title="不带namespace"></a>不带namespace</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//子进程堆栈空间大小</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> STACK_SIZE (<span class="number">1024</span> * <span class="number">1024</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> child_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> child_cmd[] = &#123;</span><br><span class="line">    <span class="string">"/bin/bash"</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">child</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Child start!\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Child pid in child process: %5d\n"</span>, getpid());</span><br><span class="line">    <span class="comment">//使用bash替换掉原进程便于观察</span></span><br><span class="line">    execv(child_cmd[<span class="number">0</span>], child_cmd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Child stop!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Parent start!\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Parent pid: %5d\n"</span>, getpid());</span><br><span class="line">    <span class="keyword">int</span> child_pid = clone(child, child_stack+STACK_SIZE, SIGCHLD, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Child pid in parent process: %5d\n"</span>, child_pid);</span><br><span class="line">    waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Parent stop!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i3@i3:~/code/namespace$ ./base</span><br><span class="line">Parent <span class="operator"><span class="keyword">start</span>!</span><br><span class="line"><span class="keyword">Parent</span> pid:  <span class="number">7816</span></span><br><span class="line"><span class="keyword">Child</span> pid <span class="keyword">in</span> <span class="keyword">parent</span> process:  <span class="number">7817</span></span><br><span class="line"><span class="keyword">Child</span> <span class="keyword">start</span>!</span><br><span class="line"><span class="keyword">Child</span> pid <span class="keyword">in</span> <span class="keyword">child</span> process:  <span class="number">7817</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="UTS"><a href="#UTS" class="headerlink" title="UTS"></a>UTS</h2><h1 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h1><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://yq.aliyun.com/articles/57743" target="_blank" rel="external">https://yq.aliyun.com/articles/57743</a><br><a href="http://coolshell.cn/articles/17049.html" target="_blank" rel="external">http://coolshell.cn/articles/17049.html</a></p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;记录一下docker基础知识&lt;/p&gt;
&lt;p&gt;namespace是环境隔离，cgroup是资源隔离，加起来就是docker的基础&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="cgroup" scheme="http://blog.decbug.com/tags/cgroup/"/>
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="namespace" scheme="http://blog.decbug.com/tags/namespace/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes尝试有状态服务</title>
    <link href="http://blog.decbug.com/2016/08/03/k8s_stateful/"/>
    <id>http://blog.decbug.com/2016/08/03/k8s_stateful/</id>
    <published>2016-08-02T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="有状态服务的概念"><a href="#有状态服务的概念" class="headerlink" title="有状态服务的概念"></a>有状态服务的概念</h1><p>既然名叫有状态，那么就与之相对，会有我们很熟悉的无状态。无状态的概念，就是只负责运算，不负责任何数据的存储，这样就能很轻松地做到水平扩展。</p>
<blockquote>
<p>之前写的关于无状态的例子</p>
</blockquote>
<p>那么，有状态的概念又是什么呢，简单来说，就是会有数据的存储，需要持久化。</p>
<a id="more"></a>
<h1 id="k8s的petset"><a href="#k8s的petset" class="headerlink" title="k8s的petset"></a>k8s的petset</h1><p>简单来说，pod是用来跑无状态服务，petset就是跑有状态服务。<br>1.3之前k8s大多是用于无状态的web应用，但是我们实际业务却有很多有状态的服务，对于谷歌来说，绝对不会放弃这一块的机会，所以petset就应运而生。</p>
<p>那么，作为有状态服务的基石，petset需要具备哪些特征呢：</p>
<ol>
<li>有唯一的编号</li>
<li>在网络上有个不会改变的标识，k8s是通过域名实现的。pod，则是名字后面还有随机数，所以需要有service来做转发</li>
<li>每个有状态服务，都需要有自己的卷，这样就能保证数据可靠存储</li>
</ol>
<h1 id="petset的典型场景"><a href="#petset的典型场景" class="headerlink" title="petset的典型场景"></a>petset的典型场景</h1><p>MySQL<br>Zookeeper<br>Cassandra<br>redis</p>
<h1 id="小试验"><a href="#小试验" class="headerlink" title="小试验"></a>小试验</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># A headless service to <span class="operator"><span class="keyword">create</span> DNS <span class="keyword">records</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  <span class="keyword">name</span>: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">80</span></span><br><span class="line">    <span class="keyword">name</span>: web</span><br><span class="line">  # *.nginx.<span class="keyword">default</span>.svc.cluster.<span class="keyword">local</span></span><br><span class="line">  clusterIP: <span class="keyword">None</span></span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">apiVersion: apps/v1alpha1</span><br><span class="line">kind: PetSet</span><br><span class="line">metadata:</span><br><span class="line">  <span class="keyword">name</span>: web</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"nginx"</span></span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  <span class="keyword">template</span>:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">      annotations:</span><br><span class="line">        pod.alpha.kubernetes.io/<span class="keyword">initialized</span>: <span class="string">"true"</span></span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: <span class="number">0</span></span><br><span class="line">      containers:</span><br><span class="line">      - <span class="keyword">name</span>: nginx</span><br><span class="line">        image: gcr.io/google_containers/nginx-slim:<span class="number">0.8</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line">          <span class="keyword">name</span>: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - <span class="keyword">name</span>: www</span><br><span class="line">          mountPath: /usr/<span class="keyword">share</span>/nginx/html</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      <span class="keyword">name</span>: www</span><br><span class="line">      annotations:</span><br><span class="line">        volume.alpha.kubernetes.io/<span class="keyword">storage</span>-<span class="keyword">class</span>: anything</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          <span class="keyword">storage</span>: <span class="number">1</span>Gi</span></span><br></pre></td></tr></table></figure>
<p>提示<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./kubectl <span class="operator"><span class="keyword">describe</span> pvc www-web-<span class="number">0</span></span><br><span class="line"><span class="keyword">Name</span>:		www-web-<span class="number">0</span></span><br><span class="line">Namespace:	<span class="keyword">default</span></span><br><span class="line"><span class="keyword">Status</span>:		Pending</span><br><span class="line">Volume:</span><br><span class="line">Labels:		app=nginx</span><br><span class="line"><span class="keyword">Capacity</span>:</span><br><span class="line"><span class="keyword">Access</span> Modes:</span><br><span class="line"><span class="keyword">Events</span>:</span><br><span class="line">  FirstSeen	LastSeen	<span class="keyword">Count</span>	<span class="keyword">From</span>				SubobjectPath	<span class="keyword">Type</span>		Reason			Message</span><br><span class="line">  <span class="comment">---------	--------	-----	----				-------------	--------	------			-------</span></span><br><span class="line">  <span class="number">5</span><span class="keyword">m</span>		<span class="number">10</span>s		<span class="number">22</span>	&#123;persistentvolume-controller &#125;			<span class="keyword">Warning</span>		ProvisioningFailed	<span class="keyword">No</span> provisioner <span class="keyword">plugin</span> <span class="keyword">found</span> <span class="keyword">for</span> the claim!</span></span><br></pre></td></tr></table></figure></p>
<p>这是因为需要设置<code>Persistent Volume Provisioning</code><br>方法是在controller manager的启动参数加上<code>--enable-hostpath-provisioner=true</code>，然后重启controller，再create就OK了。</p>
<h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h1><p><a href="https://github.com/kubernetes/kubernetes/tree/master/test/e2e/testing-manifests/petset/redis" target="_blank" rel="external">https://github.com/kubernetes/kubernetes/tree/master/test/e2e/testing-manifests/petset/redis</a></p>
<h2 id="service-yml"><a href="#service-yml" class="headerlink" title="service.yml"></a>service.yml</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># A headless service to <span class="operator"><span class="keyword">create</span> DNS <span class="keyword">records</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    service.alpha.kubernetes.io/tolerate-unready-endpoints: <span class="string">"true"</span></span><br><span class="line">  <span class="keyword">name</span>: redis</span><br><span class="line">  labels:</span><br><span class="line">    app: redis</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">6379</span></span><br><span class="line">    <span class="keyword">name</span>: peer</span><br><span class="line">  # *.redis.<span class="keyword">default</span>.svc.cluster.<span class="keyword">local</span></span><br><span class="line">  clusterIP: <span class="keyword">None</span></span><br><span class="line">  selector:</span><br><span class="line">    app: redis</span></span><br></pre></td></tr></table></figure>
<h2 id="petset-yml"><a href="#petset-yml" class="headerlink" title="petset.yml"></a>petset.yml</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1alpha1</span><br><span class="line">kind: PetSet</span><br><span class="line">metadata:</span><br><span class="line">  name: rd</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">"redis"</span></span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        <span class="keyword">app</span>: redis</span><br><span class="line">      annotations:</span><br><span class="line">        pod.<span class="keyword">alpha</span>.kubernetes.io/initialized: <span class="string">"true"</span></span><br><span class="line">        pod.<span class="keyword">alpha</span>.kubernetes.io/init-containers: '[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"install"</span>,</span><br><span class="line">                <span class="string">"image"</span>: <span class="string">"gcr.io/google_containers/redis-install-3.2.0:e2e"</span>,</span><br><span class="line">                <span class="string">"imagePullPolicy"</span>: <span class="string">"Always"</span>,</span><br><span class="line">                <span class="string">"args"</span>: [<span class="string">"--install-into=/opt"</span>, <span class="string">"--work-dir=/work-dir"</span>],</span><br><span class="line">                <span class="string">"volumeMounts"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"opt"</span>,</span><br><span class="line">                        <span class="string">"mountPath"</span>: <span class="string">"/opt"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"workdir"</span>,</span><br><span class="line">                        <span class="string">"mountPath"</span>: <span class="string">"/work-dir"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"name"</span>: <span class="string">"bootstrap"</span>,</span><br><span class="line">                <span class="string">"image"</span>: <span class="string">"debian:jessie"</span>,</span><br><span class="line">                <span class="string">"command"</span>: [<span class="string">"/work-dir/peer-finder"</span>],</span><br><span class="line">                <span class="string">"args"</span>: [<span class="string">"-on-start=\"</span>/work-<span class="keyword">dir</span>/<span class="keyword">on</span>-start.<span class="keyword">sh</span>\<span class="string">""</span>, <span class="string">"-service=redis"</span>],</span><br><span class="line">                <span class="string">"env"</span>: [</span><br><span class="line">                  &#123;</span><br><span class="line">                      <span class="string">"name"</span>: <span class="string">"POD_NAMESPACE"</span>,</span><br><span class="line">                      <span class="string">"valueFrom"</span>: &#123;</span><br><span class="line">                          <span class="string">"fieldRef"</span>: &#123;</span><br><span class="line">                              <span class="string">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">                              <span class="string">"fieldPath"</span>: <span class="string">"metadata.namespace"</span></span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"volumeMounts"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"opt"</span>,</span><br><span class="line">                        <span class="string">"mountPath"</span>: <span class="string">"/opt"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: <span class="string">"workdir"</span>,</span><br><span class="line">                        <span class="string">"mountPath"</span>: <span class="string">"/work-dir"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]'</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 0</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis</span><br><span class="line">        image: debian:jessie</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">          name: peer</span><br><span class="line">        command:</span><br><span class="line">        - /opt/redis/redis-server</span><br><span class="line">        <span class="keyword">args</span>:</span><br><span class="line">        - /opt/redis/redis.<span class="keyword">conf</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - <span class="keyword">sh</span></span><br><span class="line">            - -c</span><br><span class="line">            - <span class="string">"/opt/redis/redis-cli -h $(hostname) ping"</span></span><br><span class="line">          initialDelaySeconds: 15</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /data</span><br><span class="line">        - name: opt</span><br><span class="line">          mountPath: /opt</span><br><span class="line">      volumes:</span><br><span class="line">      - name: opt</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: workdir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">      annotations:</span><br><span class="line">        volume.<span class="keyword">alpha</span>.kubernetes.io/storage-<span class="keyword">class</span>: anything</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.infoq.com/cn/news/2015/12/scaling-stateful-services" target="_blank" rel="external">构建可伸缩的有状态服务</a></li>
<li><a href="http://docs.alauda.cn/feature/service/stateless-service-and-stateful-service.html" target="_blank" rel="external">无状态服务 vs 有状态服务</a></li>
<li><a href="http://kubernetes.io/docs/user-guide/petset/" target="_blank" rel="external">Pet Sets</a></li>
</ul>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;有状态服务的概念&quot;&gt;&lt;a href=&quot;#有状态服务的概念&quot; class=&quot;headerlink&quot; title=&quot;有状态服务的概念&quot;&gt;&lt;/a&gt;有状态服务的概念&lt;/h1&gt;&lt;p&gt;既然名叫有状态，那么就与之相对，会有我们很熟悉的无状态。无状态的概念，就是只负责运算，不负责任何数据的存储，这样就能很轻松地做到水平扩展。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;之前写的关于无状态的例子&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;那么，有状态的概念又是什么呢，简单来说，就是会有数据的存储，需要持久化。&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="kubernetes" scheme="http://blog.decbug.com/tags/kubernetes/"/>
    
      <category term="stateful" scheme="http://blog.decbug.com/tags/stateful/"/>
    
  </entry>
  
  <entry>
    <title>体验docker UCP</title>
    <link href="http://blog.decbug.com/2016/08/02/evaluate_docker_UCP/"/>
    <id>http://blog.decbug.com/2016/08/02/evaluate_docker_UCP/</id>
    <published>2016-08-01T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>docker官方也有私有云版本<br><a id="more"></a></p>
<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><h2 id="docker-engine"><a href="#docker-engine" class="headerlink" title="docker engine"></a>docker engine</h2><p>感谢Daoloud提供的一键式安装<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL http<span class="variable">s:</span>//<span class="built_in">get</span>.daocloud.io/docker | <span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ucp"><a href="#ucp" class="headerlink" title="ucp"></a>ucp</h2><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> DOCKER_TLS_VERIFY=<span class="string">"0"</span></span><br><span class="line"><span class="keyword">export</span> DOCKER_HOST=<span class="string">"tcp://104.236.158.191:2376"</span></span><br><span class="line"><span class="keyword">export</span> DOCKER_CERT_PATH=<span class="string">""</span></span><br><span class="line"><span class="keyword">export</span> DOCKER_MACHINE_NAME=<span class="string">"node1"</span></span><br><span class="line"></span><br><span class="line">docker run --rm -<span class="literal">it</span> <span class="string">\</span></span><br><span class="line">&gt; -v /<span class="keyword">var</span>/run/docker.<span class="attribute">sock</span>:/<span class="keyword">var</span>/run/docker.sock <span class="string">\</span></span><br><span class="line">&gt; --name ucp docker/ucp install -i <span class="string">\</span></span><br><span class="line">&gt; --swarm-port <span class="number">3376</span> --host-address <span class="number">104.236</span>.<span class="number">158.191</span></span><br></pre></td></tr></table></figure>
<p>提示<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could <span class="operator">not</span> <span class="built_in">read</span> CA certificate <span class="string">"/root/.docker/ca.pem"</span>: <span class="built_in">open</span> /root/.docker/ca.pem: no such <span class="built_in">file</span> <span class="operator">or</span> <span class="built_in">directory</span></span><br></pre></td></tr></table></figure></p>
<p>看来需要生成一个<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl req -out ca.pem -<span class="keyword">new</span> -x509</span><br><span class="line"><span class="preprocessor"># aaaa</span></span><br><span class="line"><span class="preprocessor"># <span class="number">104.236</span><span class="number">.158</span><span class="number">.191</span></span></span><br></pre></td></tr></table></figure></p>
<p>再次运行run<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Unable to find image 'docker/ucp:latest' locally</span><br><span class="line">latest: Pulling from docker/ucp</span><br><span class="line">e110a4a17941: Pull complete</span><br><span class="line">a1c3e1c9e147: Pull complete</span><br><span class="line">bca4748868da: Pull complete</span><br><span class="line">Digest: sha256:46154615e2429a9a8f3d019c414f69cd47f9f7dd5d5c35f54016c01fad1d99ef</span><br><span class="line">Status: Downloaded newer image for docker/ucp:latest</span><br><span class="line">INFO[0000] Verifying your system is compatible with UCP</span><br><span class="line">INFO[0000] Your engine version 1.12.0, build 8eab29e (4.4.0-31-generic) is compatible</span><br><span class="line">WARN[0000] Your system does not have enough memory.  UCP suggests a minimum of 2.00 GB, but you only have 0.97 GB.  You may have unexpected errors.</span><br><span class="line">Please choose your initial UCP admin password:</span><br><span class="line">Confirm your initial password:</span><br><span class="line">INFO[0024] Pulling required images... (this may take a while)</span><br><span class="line">WARN[0080] None of the hostnames we'll be using in the UCP certificates [ubuntu-1gb-sfo1-01 127.0.0.1 172.17.0.1 104.236.158.191] contain a domain component.  Your generated certs may fail TLS validation unless you only <span class="operator"><span class="keyword">use</span> one <span class="keyword">of</span> these shortnames <span class="keyword">or</span> IPs <span class="keyword">to</span> <span class="keyword">connect</span>.  You can <span class="keyword">use</span> the <span class="comment">--san flag to add more aliases</span></span><br><span class="line"></span><br><span class="line">You may enter additional aliases (SANs) <span class="keyword">now</span> <span class="keyword">or</span> press enter <span class="keyword">to</span> proceed <span class="keyword">with</span> the above <span class="keyword">list</span>.</span><br><span class="line">Additional aliases: abc</span><br><span class="line">INFO[<span class="number">0192</span>] Installing UCP <span class="keyword">with</span> host address <span class="number">104.236</span><span class="number">.158</span><span class="number">.191</span> - <span class="keyword">If</span> this <span class="keyword">is</span> incorrect, please specify an alternative address <span class="keyword">with</span> the <span class="string">'--host-address'</span> flag</span><br><span class="line">INFO[<span class="number">0000</span>] Checking that <span class="keyword">required</span> ports <span class="keyword">are</span> available <span class="keyword">and</span> <span class="keyword">accessible</span></span><br><span class="line">INFO[<span class="number">0005</span>] Generating UCP Cluster Root CA</span><br><span class="line">INFO[<span class="number">0047</span>] Generating UCP <span class="keyword">Client</span> Root CA</span><br><span class="line">INFO[<span class="number">0060</span>] Deploying UCP Containers</span><br><span class="line">INFO[<span class="number">0113</span>] <span class="keyword">New</span> configuration established.  Signalling the daemon <span class="keyword">to</span> <span class="keyword">load</span> it...</span><br><span class="line">INFO[<span class="number">0114</span>] Successfully delivered signal <span class="keyword">to</span> daemon</span><br><span class="line">INFO[<span class="number">0114</span>] UCP <span class="keyword">instance</span> <span class="keyword">ID</span>: DKVU:ULUA:C3SO:O36W:<span class="number">4</span>WUE:OM4Z:<span class="number">5</span>V4X:IA46:ZLS5:L2KE:KE5J:O56D</span><br><span class="line">INFO[<span class="number">0114</span>] UCP <span class="keyword">Server</span> SSL: <span class="keyword">SHA</span>-<span class="number">256</span> Fingerprint=<span class="number">71</span>:C8:<span class="number">1</span><span class="keyword">D</span>:AB:CA:EE:E7:<span class="number">91</span>:<span class="number">07</span>:D6:<span class="number">23</span>:<span class="number">83</span>:F2:A7:<span class="number">67</span>:<span class="number">2</span>A:F8:DE:<span class="number">88</span>:<span class="number">43</span>:<span class="number">5</span><span class="keyword">C</span>:D4:<span class="number">2</span><span class="keyword">E</span>:<span class="number">76</span>:<span class="number">9</span><span class="keyword">D</span>:BA:B9:<span class="number">39</span>:B4:<span class="number">11</span>:<span class="number">64</span>:<span class="number">86</span></span><br><span class="line">INFO[<span class="number">0114</span>] Login <span class="keyword">as</span> <span class="string">"admin"</span>/(your <span class="keyword">admin</span> <span class="keyword">password</span>) <span class="keyword">to</span> UCP <span class="keyword">at</span> https://<span class="number">104.236</span><span class="number">.158</span><span class="number">.191</span>:<span class="number">443</span></span></span><br></pre></td></tr></table></figure></p>
<p>安装完成，效果图<br><img src="https://cloud.githubusercontent.com/assets/5423628/17329710/6027e182-58f6-11e6-99cb-8f37aef00ccf.png" alt="效果图"></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="系统容器"><a href="#系统容器" class="headerlink" title="系统容器"></a>系统容器</h2><table>
<thead>
<tr>
<th>NODE</th>
<th>NAME</th>
<th>IMAGE</th>
<th>CREATED</th>
</tr>
</thead>
<tbody>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-controller</td>
<td>docker/ucp-controller:1.1.2</td>
<td>2016-08-02 20:30:12 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-auth-worker</td>
<td>docker/ucp-auth:1.1.2</td>
<td>2016-08-02 20:30:09 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-auth-api</td>
<td>docker/ucp-auth:1.1.2</td>
<td>2016-08-02 20:30:08 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-auth-store</td>
<td>docker/ucp-auth-store:1.1.2</td>
<td>2016-08-02 20:30:04 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-cluster-root-ca</td>
<td>docker/ucp-cfssl:1.1.2</td>
<td>2016-08-02 20:30:03 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-client-root-ca</td>
<td>docker/ucp-cfssl:1.1.2</td>
<td>2016-08-02 20:30:02 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-swarm-manager</td>
<td>docker/ucp-swarm:1.1.2</td>
<td>2016-08-02 20:30:01 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-swarm-join</td>
<td>docker/ucp-swarm:1.1.2</td>
<td>2016-08-02 20:30:01 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-proxy</td>
<td>docker/ucp-proxy:1.1.2</td>
<td>2016-08-02 20:29:59 +0800</td>
</tr>
<tr>
<td>ubuntu-1gb-sfo1-01</td>
<td>ucp-kv</td>
<td>docker/ucp-etcd:1.1.2</td>
<td>2016-08-02 20:29:56 +0800</td>
</tr>
</tbody>
</table>
<p><img src="https://docs.docker.com/ucp/images/architecture-3.png" alt="官网的架构图"></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ucp-proxy</td>
<td>A TLS proxy. It allows secure access to the local Docker Engine.</td>
</tr>
<tr>
<td>ucp-controller</td>
<td>The UCP application. It uses the key-value store for persisting configurations.</td>
</tr>
<tr>
<td>ucp-swarm-manager</td>
<td>Provides the clustering capabilities. It uses the key-value store for leader election, and keeping track of cluster members.</td>
</tr>
<tr>
<td>ucp-swarm-join</td>
<td>Heartbeat to record on the key-value store that this node is alive. If the node goes down, this heartbeat stops, and the node is removed from the cluster.</td>
</tr>
<tr>
<td>ucp-auth-api</td>
<td>The centralized API for identity and authentication used by UCP and DTR.</td>
</tr>
<tr>
<td>ucp-auth-worker</td>
<td>Performs scheduled LDAP synchronizations and cleans data on the ucp-auth-store.</td>
</tr>
<tr>
<td>ucp-auth-store</td>
<td>Stores authentication configurations, and data for users, organizations and teams.</td>
</tr>
<tr>
<td>ucp-kv</td>
<td>Used to store the UCP configurations. Don’t use it in your applications, since it’s for internal use only.</td>
</tr>
<tr>
<td>ucp-cluster-root-ca</td>
<td>A certificate authority to sign the certificates used when joining new nodes, and on administrator client bundles.</td>
</tr>
<tr>
<td>ucp-client-root-ca</td>
<td>A certificate authority to sign user bundles. Only used when UCP is installed without an external root CA.</td>
</tr>
</tbody>
</table>
<p>基本上明白都有什么作用了</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;docker官方也有私有云版本&lt;br&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="UCP" scheme="http://blog.decbug.com/tags/UCP/"/>
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes多租户分析</title>
    <link href="http://blog.decbug.com/2016/08/01/k8s_multi_tenant/"/>
    <id>http://blog.decbug.com/2016/08/01/k8s_multi_tenant/</id>
    <published>2016-07-31T17:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>公有云产品有个很重要的概念叫多租户，比如OpenStack的Domain/Project。提供资源隔离，权限控制，等等。<br>kubernetes如果作为PaaS的基础，那么也需要具备此能力。<br><a id="more"></a></p>
<h1 id="NameSpace"><a href="#NameSpace" class="headerlink" title="NameSpace"></a>NameSpace</h1><blockquote>
<p>Kubernetes supports multiple virtual clusters backed by the same physical cluster. These virtual clusters are called namespaces.</p>
</blockquote>
<p>一组逻辑的集群，可以大概类似于租户的概念，可以做到一定程度的资源隔离，Quota。如果非要和OpenStack做个映射，那么就大概对应于Project吧。</p>
<p>举个例子</p>
<ul>
<li>kubectl –namespace=abc run nginx –image=nginx</li>
<li>kubectl  run nginx –image=nginx<br>这两条命令虽然都是run起来一个nginx，但是作用域却不一样。命令1是在一个叫abc的namespace里运行nginx，命令2则是在Default</li>
</ul>
<h1 id="Resource-Quota"><a href="#Resource-Quota" class="headerlink" title="Resource Quota"></a>Resource Quota</h1><blockquote>
<p>A resource quota, defined by a ResourceQuota object, provides constraints that limit aggregate resource consumption per namespace.<br>限制某个name space的资源总数</p>
</blockquote>
<p>使用方法: It is enabled when the apiserver –admission-control= flag has ResourceQuota as one of its arguments</p>
<h2 id="Compute-Resource-Quota"><a href="#Compute-Resource-Quota" class="headerlink" title="Compute Resource Quota"></a>Compute Resource Quota</h2><table>
<thead>
<tr>
<th>Resource Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>Across all pods in a non-terminal state, the sum of CPU requests cannot exceed this value.</td>
</tr>
<tr>
<td>limits.cpu</td>
<td>Across all pods in a non-terminal state, the sum of CPU limits cannot exceed this value.</td>
</tr>
<tr>
<td>limits.memory</td>
<td>Across all pods in a non-terminal state, the sum of memory limits cannot exceed this value.</td>
</tr>
<tr>
<td>memory</td>
<td>Across all pods in a non-terminal state, the sum of memory requests cannot exceed this value.</td>
</tr>
<tr>
<td>requests.cpu</td>
<td>Across all pods in a non-terminal state, the sum of CPU requests cannot exceed this value.</td>
</tr>
<tr>
<td>requests.memory</td>
<td>Across all pods in a non-terminal state, the sum of memory requests cannot exceed this value.</td>
</tr>
</tbody>
</table>
<h2 id="Object-Count-Quota"><a href="#Object-Count-Quota" class="headerlink" title="Object Count Quota"></a>Object Count Quota</h2><table>
<thead>
<tr>
<th>Resource Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>configmaps</td>
<td>The total number of config maps that can exist in the namespace.</td>
</tr>
<tr>
<td>persistentvolumeclaims</td>
<td>The total number of persistent volume claims that can exist in the namespace.</td>
</tr>
<tr>
<td>pods</td>
<td>The total number of pods in a non-terminal state that can exist in the namespace. A pod is in a terminal state if status.phase in (Failed, Succeeded) is true.</td>
</tr>
<tr>
<td>replicationcontrollers</td>
<td>The total number of replication controllers that can exist in the namespace.</td>
</tr>
<tr>
<td>resourcequotas</td>
<td>The total number of resource quotas that can exist in the namespace.</td>
</tr>
<tr>
<td>services</td>
<td>The total number of services that can exist in the namespace.</td>
</tr>
<tr>
<td>services.loadbalancers</td>
<td>The total number of services of type load balancer that can exist in the namespace.</td>
</tr>
<tr>
<td>services.nodeports</td>
<td>The total number of services of type node port that can exist in the namespace.</td>
</tr>
<tr>
<td>secrets</td>
<td>The total number of secrets that can exist in the namespace.</td>
</tr>
</tbody>
</table>
<p>对象的总数，比如限制最多可以创建几个pod，最多几个rc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe quota compute-resources --<span class="keyword">namespace</span>=myspace</span><br><span class="line">Name:                  compute-resources</span><br><span class="line">Namespace:             myspace</span><br><span class="line">Resource               Used Hard</span><br><span class="line">--------               ---- ----</span><br><span class="line">limits.cpu             <span class="number">0</span>    <span class="number">2</span></span><br><span class="line">limits.memory          <span class="number">0</span>    <span class="number">2</span>Gi</span><br><span class="line">pods                   <span class="number">0</span>    <span class="number">4</span></span><br><span class="line">requests.cpu           <span class="number">0</span>    <span class="number">1</span></span><br><span class="line">requests.memory        <span class="number">0</span>    <span class="number">1</span>Gi</span><br><span class="line"></span><br><span class="line">$ kubectl describe quota object-counts --<span class="keyword">namespace</span>=myspace</span><br><span class="line">Name:                   object-counts</span><br><span class="line">Namespace:              myspace</span><br><span class="line">Resource                Used    Hard</span><br><span class="line">--------                ----    ----</span><br><span class="line">configmaps              <span class="number">0</span>       <span class="number">10</span></span><br><span class="line">persistentvolumeclaims  <span class="number">0</span>       <span class="number">4</span></span><br><span class="line">replicationcontrollers  <span class="number">0</span>       <span class="number">20</span></span><br><span class="line">secrets                 <span class="number">1</span>       <span class="number">10</span></span><br><span class="line">services                <span class="number">0</span>       <span class="number">10</span></span><br><span class="line">services.loadbalancers  <span class="number">0</span>       <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h1 id="Limit-Range"><a href="#Limit-Range" class="headerlink" title="Limit Range"></a>Limit Range</h1><p>需要在Admission Controller启用LimitRanger插件</p>
<p>By default, pods run with unbounded CPU and memory limits.</p>
<p>Let’s create a simple limit in our namespace.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="operator"><span class="keyword">create</span> -<span class="keyword">f</span> docs/<span class="keyword">admin</span>/limitrange/limits.yaml <span class="comment">--namespace=limit-example</span></span><br><span class="line"></span><br><span class="line">limitrange <span class="string">"mylimits"</span> created</span></span><br></pre></td></tr></table></figure></p>
<p>Let’s describe the limits that we have imposed in our namespace.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="operator"><span class="keyword">describe</span> limits mylimits <span class="comment">--namespace=limit-example</span></span><br><span class="line"><span class="keyword">Name</span>:   mylimits</span><br><span class="line">Namespace:  <span class="keyword">limit</span>-example</span><br><span class="line"><span class="keyword">Type</span>        <span class="keyword">Resource</span>      <span class="keyword">Min</span>      <span class="keyword">Max</span>      <span class="keyword">Default</span> Request      <span class="keyword">Default</span> <span class="keyword">Limit</span>      <span class="keyword">Max</span> <span class="keyword">Limit</span>/Request Ratio</span><br><span class="line"><span class="comment">----        --------      ---      ---      ---------------      -------------      -----------------------</span></span><br><span class="line">Pod         cpu           <span class="number">200</span><span class="keyword">m</span>     <span class="number">2</span>        -                    -                  -</span><br><span class="line">Pod         <span class="keyword">memory</span>        <span class="number">6</span>Mi      <span class="number">1</span>Gi      -                    -                  -</span><br><span class="line"><span class="keyword">Container</span>   cpu           <span class="number">100</span><span class="keyword">m</span>     <span class="number">2</span>        <span class="number">200</span><span class="keyword">m</span>                 <span class="number">300</span><span class="keyword">m</span>               -</span><br><span class="line"><span class="keyword">Container</span>   <span class="keyword">memory</span>        <span class="number">3</span>Mi      <span class="number">1</span>Gi      <span class="number">100</span>Mi                <span class="number">200</span>Mi              -</span></span><br></pre></td></tr></table></figure></p>
<h1 id="ABAC"><a href="#ABAC" class="headerlink" title="ABAC"></a>ABAC</h1><p>限定某个用户能做的事情，比如<br>Alice can do anything to all resources:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "<span class="attribute">apiVersion</span>":<span class="value"><span class="string">"abac.authorization.kubernetes.io/v1beta1"</span></span>,</span><br><span class="line">    "<span class="attribute">kind</span>":<span class="value"><span class="string">"Policy"</span></span>,</span><br><span class="line">    "<span class="attribute">spec</span>":<span class="value">&#123;</span><br><span class="line">        "<span class="attribute">user</span>":<span class="value"><span class="string">"alice"</span></span>,</span><br><span class="line">        "<span class="attribute">namespace</span>":<span class="value"><span class="string">"*"</span></span>,</span><br><span class="line">        "<span class="attribute">resource</span>":<span class="value"><span class="string">"*"</span></span>,</span><br><span class="line">        "<span class="attribute">apiGroup</span>":<span class="value"><span class="string">"*"</span></span><br><span class="line">    </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>Bob can just read pods in namespace “projectCaribou”<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "<span class="attribute">apiVersion</span>":<span class="value"><span class="string">"abac.authorization.kubernetes.io/v1beta1"</span></span>,</span><br><span class="line">    "<span class="attribute">kind</span>":<span class="value"><span class="string">"Policy"</span></span>,</span><br><span class="line">    "<span class="attribute">spec</span>":<span class="value">&#123;</span><br><span class="line">        "<span class="attribute">user</span>":<span class="value"><span class="string">"bob"</span></span>,</span><br><span class="line">        "<span class="attribute">namespace</span>":<span class="value"><span class="string">"projectCaribou"</span></span>,</span><br><span class="line">        "<span class="attribute">resource</span>":<span class="value"><span class="string">"pods"</span></span>,</span><br><span class="line">        "<span class="attribute">readonly</span>":<span class="value"><span class="literal">true</span></span><br><span class="line">    </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>缺点是，必须在api server启动的时候就传入文件。如果需要对权限做修改，那么必须重启api server才能生效</p>
<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>之前提到了ABAC比较弱，所以呢1.3出来个新特性，叫RBAC，目前还是Alpha。<br>从名字就能看出来<code>“RBAC” (Role-Based Access Control)</code>，基于角色，有点像OpenStack的角色了</p>
<h2 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: Role</span><br><span class="line"><span class="attribute">apiVersion</span>: rbac.authorization.k8s.io/v1alpha1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">namespace</span>: default</span><br><span class="line">  <span class="attribute">name</span>: pod-reader</span><br><span class="line"><span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">apiGroups</span>: [<span class="string">""</span>] # The API group <span class="string">""</span> indicates the default API Group.</span><br><span class="line">    <span class="attribute">resources</span>: [<span class="string">"pods"</span>]</span><br><span class="line">    <span class="attribute">verbs</span>: [<span class="string">"get"</span>, <span class="string">"watch"</span>, <span class="string">"list"</span>]</span><br><span class="line">    <span class="attribute">nonResourceURLs</span>: []</span><br></pre></td></tr></table></figure>
<h2 id="RolesBindings"><a href="#RolesBindings" class="headerlink" title="RolesBindings"></a>RolesBindings</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This role binding allows "jane" to read pods in the namespace "default"</span></span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1alpha1</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="operator">read</span>-pods</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">  - kind: <span class="keyword">User</span> <span class="title"># May</span> be <span class="string">"User"</span>, <span class="string">"Group"</span> <span class="operator">or</span> <span class="string">"ServiceAccount"</span></span><br><span class="line">    name: jane</span><br><span class="line">roleRef:</span><br><span class="line">  kind: <span class="keyword">Role</span></span><br><span class="line">  <span class="title">namespace</span>: default</span><br><span class="line">  name: pod-reader</span><br><span class="line">  apiVersion: rbac.authorization.k8s.io/v1alpha1</span><br></pre></td></tr></table></figure>
<h2 id="一图胜千言"><a href="#一图胜千言" class="headerlink" title="一图胜千言"></a>一图胜千言</h2><img src="http://www.plantuml.com/plantuml/svg/POux2e1034Jxd2BOMsmE8EWrP96eGKIDYujOY7VtZx2Ma_TcYEEguqOmKXx4Ewx4HCWUrHjS0JO0zpFeCUWMycdinTWuEJgGprwcz0ZNjIXRhLjjZ8KWFy89paPcCPxTl_NHUbmqu1Iiqhlw0hgUeXq0">
<p>userA和userB是通过<code>[role_binding1][role1]</code>连接到name space 1，得到在name space1进行操作的权限。<br>userB则是<code>[role_binding2]-&gt;[role2]</code>得到在name space2进行操作的权限。</p>
<h1 id="webhook"><a href="#webhook" class="headerlink" title="webhook"></a>webhook</h1><p>感觉很强大，是否可以和keystone对接？把OpenStack的多租户能力借鉴过来？</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;公有云产品有个很重要的概念叫多租户，比如OpenStack的Domain/Project。提供资源隔离，权限控制，等等。&lt;br&gt;kubernetes如果作为PaaS的基础，那么也需要具备此能力。&lt;br&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="kubernetes" scheme="http://blog.decbug.com/tags/kubernetes/"/>
    
      <category term="multi-tenant" scheme="http://blog.decbug.com/tags/multi-tenant/"/>
    
  </entry>
  
  <entry>
    <title>在家玩DaoCloud企业版--部署/网络/存储</title>
    <link href="http://blog.decbug.com/2016/07/25/play_dce3/"/>
    <id>http://blog.decbug.com/2016/07/25/play_dce3/</id>
    <published>2016-07-24T17:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>前面分析了系统容器，<br><a href="http://blog.decbug.com/2016/07/25/play_dce2/">http://blog.decbug.com/2016/07/25/play_dce2/</a><br>接下来看看到底是如何部署的，以及网络存储是如何创建的。<br><a id="more"></a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>去掉–rm ，看看install到底做了什么<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -<span class="tag">i</span>  daocloud.io/daocloud/dce install</span><br></pre></td></tr></table></figure></p>
<p>不加–rm竟然无法运行，DaoCloud还挺厉害</p>
<p>大概推测一下部署过程吧</p>
<ul>
<li>daocloud.io/daocloud/dce install 安装compose？</li>
<li>生成/etc/daocloud/dce/docker-compose.yml</li>
<li>docker-compose up ?</li>
</ul>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><h2 id="准备证书"><a href="#准备证书" class="headerlink" title="准备证书"></a>准备证书</h2><p>docker -H :2375 network ls 查看network</p>
<p>但是提示 没有证书</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker cp <span class="string">c165f85044a9:</span><span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>engine<span class="regexp">/engine-cert.pem /</span>etc<span class="regexp">/ssl/</span><span class="keyword">private</span><span class="regexp">/engine/</span>engine-cert.pem</span><br><span class="line">docker cp <span class="string">c165f85044a9:</span><span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>engine<span class="regexp">/engine-key.pem /</span>etc<span class="regexp">/ssl/</span><span class="keyword">private</span><span class="regexp">/engine/</span>engine-key.pem</span><br><span class="line">docker cp <span class="string">c165f85044a9:</span><span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>engine<span class="regexp">/ca.pem /</span>etc<span class="regexp">/ssl/</span><span class="keyword">private</span><span class="regexp">/engine/</span>ca.pem</span><br></pre></td></tr></table></figure>
<p>把证书从manager容器里拷贝出来</p>
<h2 id="然后network-ls"><a href="#然后network-ls" class="headerlink" title="然后network ls"></a>然后network ls</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -<span class="string">H :</span><span class="number">2375</span> --tls --tlscacert <span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>engine<span class="regexp">/ca.pem --tlscert /</span>etc<span class="regexp">/ssl/</span><span class="keyword">private</span><span class="regexp">/engine/</span>engine-cert.pem --tlskey <span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>engine/engine-key.pem network ls</span><br></pre></td></tr></table></figure>
<p>结果是<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NETWORK ID          NAME                                   DRIVER</span><br><span class="line">bd796525b91c        docker-<span class="number">512</span>mb-sfo2-<span class="number">01</span>/bridge            bridge</span><br><span class="line"><span class="number">26e3</span>c48a34b9        docker-<span class="number">512</span>mb-sfo2-<span class="number">01</span>/dce_default       bridge</span><br><span class="line">b6928df6352f        docker-<span class="number">512</span>mb-sfo2-<span class="number">01</span>/host              host</span><br><span class="line"><span class="number">242e13239</span>dcb        docker-<span class="number">512</span>mb-sfo2-<span class="number">01</span>/none              null</span><br><span class="line"><span class="number">0</span>ea714042165        docker-<span class="number">512</span>mb-sfo2-<span class="number">02</span>/bridge            bridge</span><br><span class="line">ea7e447dbb71        docker-<span class="number">512</span>mb-sfo2-<span class="number">02</span>/dce_default       bridge</span><br><span class="line">e61de07d7d1f        docker-<span class="number">512</span>mb-sfo2-<span class="number">02</span>/docker_gwbridge   bridge</span><br><span class="line"><span class="number">38</span>af5aff9349        docker-<span class="number">512</span>mb-sfo2-<span class="number">02</span>/host              host</span><br><span class="line">c448a5c9ee19        docker-<span class="number">512</span>mb-sfo2-<span class="number">02</span>/none              null</span><br><span class="line"><span class="number">48</span>ac6678f478        tty_default                            overlay</span><br><span class="line">bd2f14e19718        ubuntusshttyjs_default                 overlay</span><br></pre></td></tr></table></figure></p>
<p>可以看到，自建容器都是用到了overlay，目测用的就是docker原生的overlay</p>
<p><img src="https://cloud.githubusercontent.com/assets/5423628/17141722/d736523a-537f-11e6-8516-1ae20ba49f26.png" alt="image"></p>
<p>从上图可以看到，果然是原生overlay</p>
<h1 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/17107783/4bda1fee-52c3-11e6-9485-d77436874107.png" alt="存储"><br>貌似只能挂本地卷</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;前面分析了系统容器，&lt;br&gt;&lt;a href=&quot;http://blog.decbug.com/2016/07/25/play_dce2/&quot;&gt;http://blog.decbug.com/2016/07/25/play_dce2/&lt;/a&gt;&lt;br&gt;接下来看看到底是如何部署的，以及网络存储是如何创建的。&lt;br&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="DaoCloud" scheme="http://blog.decbug.com/tags/DaoCloud/"/>
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="swarm" scheme="http://blog.decbug.com/tags/swarm/"/>
    
  </entry>
  
  <entry>
    <title>在家玩DaoCloud企业版--分析系统容器</title>
    <link href="http://blog.decbug.com/2016/07/25/play_dce2/"/>
    <id>http://blog.decbug.com/2016/07/25/play_dce2/</id>
    <published>2016-07-24T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>DaoCloud是国内领先的容器云，我的山寨容器云需要多向他学习。<br>前几天把环境弄好了，也简单试用了，大概知道DCE技术栈。<br><a href="http://blog.decbug.com/2016/07/20/play_dce/">http://blog.decbug.com/2016/07/20/play_dce/</a><br>果然是把docker原生技术发挥到了很棒的境界，很值得学习。</p>
<a id="more"></a>
<h1 id="系统应用"><a href="#系统应用" class="headerlink" title="系统应用"></a>系统应用</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/17101264/3635ecee-52a6-11e6-82c7-308f7384b628.png" alt=""><br>有controller，agent，manager，etcd，4个容器<br>从名字上来看</p>
<ul>
<li>controller应该是nginx+UI+reigstry的组合</li>
<li>agent，应该是swarm agent</li>
<li>manager，不用说，是swarm manager吧</li>
<li>etcd，做分布式存储</li>
</ul>
<p>接下来我一个个exec进去看看</p>
<h1 id="controller容器"><a href="#controller容器" class="headerlink" title="controller容器"></a>controller容器</h1><p>本来想用ps aux看下进程，竟然提示cmd不存在，看来DaoCloud对为了减少镜像体积，做了很深入的优化。</p>
<h2 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h2><p>当然，这个难不倒我，在/proc/里找到进程ID，然后cat每个进程的cmd，方法<br><code>find /proc -mindepth 2 -maxdepth 2 -name exe -exec ls -lh {} \; 2&gt;/dev/null</code><br>结果</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">1</span>/exe -&gt; /usr/bin/python2.<span class="number">7</span></span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">6</span>/exe -&gt; /usr/local/bin/dce-nginx</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">7</span>/exe -&gt; /usr/local/bin/dce-stream</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">11</span>/exe -&gt; /usr/sbin/nginx</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">12</span>/exe -&gt; /usr/local/bin/redis-server</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">15</span>/exe -&gt; /usr/local/bin/dce-controller</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">27</span>/exe -&gt; /usr/local/bin/dce-stream</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">30</span>/exe -&gt; /usr/local/bin/dce-controller</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">53</span> /<span class="keyword">proc</span>/<span class="number">5289</span>/exe -&gt; /usr/local/bin/dce-controller</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">52</span> /<span class="keyword">proc</span>/<span class="number">5297</span>/exe -&gt; /usr/local/bin/dce-registry</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">52</span> /<span class="keyword">proc</span>/<span class="number">5302</span>/exe -&gt; /usr/local/bin/registry</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">52</span> /<span class="keyword">proc</span>/<span class="number">5309</span>/exe -&gt; /usr/sbin/nginx</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">52</span> /<span class="keyword">proc</span>/<span class="number">5657</span>/exe -&gt; /bin/bash</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">0</span> <span class="type">Jul</span> <span class="number">25</span> <span class="number">12</span>:<span class="number">59</span> /<span class="keyword">proc</span>/<span class="number">5707</span>/exe -&gt; /usr/bin/find</span><br></pre></td></tr></table></figure>
<ul>
<li>进程1是python，可能是监控进程</li>
<li>进程6、11、5309，nginx，目测是worker</li>
<li>进程7和27，stream是什么么？记得首页上有个资源使用情况预测吗？</li>
<li>进程12，redis，看来是用来做持久化了哦</li>
<li>进程15、30、5289， dce-controller，不清楚，还需要分析，难道也是UI？</li>
<li>5279，5302，为啥有两个registry</li>
<li>后面两个都是我产生的进程，可以忽略。</li>
</ul>
<h2 id="进一步分析"><a href="#进一步分析" class="headerlink" title="进一步分析"></a>进一步分析</h2><p>把所有PID的cmdline都cat出来看看<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">files</span>=$(<span class="keyword">find</span> /proc -<span class="built_in">type</span> <span class="keyword">f</span> -name <span class="string">'cmdline'</span> | <span class="keyword">grep</span> -<span class="keyword">v</span> <span class="string">'task'</span> | <span class="keyword">grep</span> -<span class="keyword">v</span> <span class="string">"/proc/cmdline"</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">file</span> in $<span class="keyword">files</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">cat</span> $<span class="keyword">file</span> &gt;&gt; aaa</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">""</span> &gt;&gt; aaa</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>结果<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>bin<span class="regexp">/python/</span>usr<span class="regexp">/bin/</span>supervisord</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-nginx</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-stream</span><br><span class="line"><span class="string">nginx:</span> master process nginx -g daemon off;</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>redis-server *:<span class="number">6379</span></span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-controller</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-stream</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-controller</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-controller</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>dce-registry</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>registryserve<span class="regexp">/etc/</span>docker<span class="regexp">/registry/</span>conf.yml</span><br><span class="line"><span class="string">nginx:</span> worker process</span><br><span class="line">bash</span><br></pre></td></tr></table></figure></p>
<p>通过命令行，每个进程的作用就更清晰了<br>再来分析一遍</p>
<ul>
<li>进程1是python，supervisord，果然是监控进程</li>
<li>进程6、11、5309，nginx，果然是master+worker</li>
<li>进程7和27，stream是什么么？记得首页上有个资源使用情况预测吗？</li>
<li>进程12，redis，看来是用来做持久化了哦</li>
<li>进程15、30、5289， dce-controller，应该就是UI？还可能会接受各个节点上报的资源使用情况</li>
<li>5279，5302，为啥有两个registry<ul>
<li>dce-registry 可能是index，用来做权限控制的？</li>
<li>registry就仓库了</li>
</ul>
</li>
</ul>
<h2 id="推测代码"><a href="#推测代码" class="headerlink" title="推测代码"></a>推测代码</h2><p>nginx 配置<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">upstream</span> registry &#123;</span><br><span class="line">  <span class="title">server</span> registry:<span class="number">5000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">upstream</span> ui &#123;</span><br><span class="line">  <span class="title">server</span> ui:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">server</span> &#123;</span><br><span class="line">  <span class="title">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title">location</span> /v2/ &#123;</span><br><span class="line">    <span class="title">proxy_pass</span> <span class="url">http://registry/v2/</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title">location</span> / &#123;</span><br><span class="line">    <span class="title">proxy_pass</span> <span class="url">http://ui/</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<img src="http://www.plantuml.com/plantuml/svg/AyaioKbLA2ujI2qgoopEBqfvFdlYixxbJrjNl6nUyMB_xEShkhcuClDAKelI4fDJ5PIISp9JyqgK51AB5Povk58IInAJ4ek1uaMfAPd5IWhLNBLSN6dvEIcfHGfAJtPFVhfhCbXjHcbIDPS244GNfQPd5fSKLSP2k2d9gV5eGd2kZQwk7Pe2e0gW1T5vwPbv5R5mXe9kQG5KQN9-NabHVavEQb6ibKA2VW8M9N3JG0hAZ41gq7GgwEQaffNese4znHKDL9oQc8ig2W00">
<h1 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h1><p>etcd没有刻意分析的必要，看下启动命令<br><code>/etcd --name dce-etcd-138.68.2.15 --data-dir /data</code></p>
<h1 id="manager"><a href="#manager" class="headerlink" title="manager"></a>manager</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/17104503/ce03684e-52b5-11e6-965a-21697a61fede.png" alt="启动命令"><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/swarm manage --replication --engine-refresh-min-interval 5s --engine-refresh-max-interval 10s --tls --tlscacert /</span>etc<span class="regexp">/ssl/</span><span class="keyword">private</span><span class="regexp">/engine/</span>ca.pem --tlscert <span class="regexp">/etc/</span>ssl<span class="regexp">/private/</span>engine<span class="regexp">/engine-cert.pem --tlskey /</span>etc<span class="regexp">/ssl/</span><span class="keyword">private</span><span class="regexp">/engine/</span>engine-key.pem <span class="string">etcd:</span><span class="comment">//dce_etcd_1:2379</span></span><br></pre></td></tr></table></figure></p>
<p>比我之前用的swarm多了证书，etcd的地址应该是通过compose的service创建的网络来互联的</p>
<h1 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h1><p>启动命令<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>supervisord.sh</span><br></pre></td></tr></table></figure></p>
<p>结合部署节点的命令<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash </span>-c <span class="string">"$(docker run -i --rm daocloud.io/daocloud/dce join &#123;你的控制器IP&#125;)"</span></span><br></pre></td></tr></table></figure></p>
<p>应该是把控制节点的IP写入到supervisord.sh，然后调用swarm join</p>
<h1 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h1><p>仅仅是猜测，还是不够，还得找出compose来看看，看下到底是怎么写的<br>通过ps aux找到了一个daotunnel，他的启动命令是<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">daomonit</span>/<span class="title">daotunnel</span> -<span class="title">log</span> /<span class="title">var</span>/<span class="title">log</span>/<span class="title">daotunnel</span>.<span class="title">log</span> -<span class="title">config</span> /<span class="title">etc</span>/<span class="title">daocloud</span>/<span class="title">daotunnel</span>.<span class="title">yml</span> <span class="title">start</span> <span class="title">docker</span> <span class="title">dce</span>-<span class="title">controller</span></span></span><br></pre></td></tr></table></figure></p>
<p>看来好货都藏在<code>/etc/daocloud/</code>里</p>
<p>源码之下没有密码，慢慢看吧<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  agent:</span><br><span class="line">    depends_on:</span><br><span class="line">    -<span class="ruby"> etcd</span><br><span class="line"></span>    environment:</span><br><span class="line">    -<span class="ruby"> <span class="constant">SWARM_ADVERTISE</span>=<span class="number">138.68</span>.<span class="number">2.15</span><span class="symbol">:</span><span class="number">12376</span></span><br><span class="line"></span>    -<span class="ruby"> <span class="constant">SWARM_AGENT_ARGS</span>=join <span class="symbol">etcd:</span>/<span class="regexp">/138.68.2.15:12379</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> CADVISOR_ARGS=-housekeeping_interval=1m --global_housekeeping_interval=1m -max_housekeeping_interval=10m</span><br><span class="line"></span></span>    image: daocloud.io/daocloud/dce-agent:1.3.2</span><br><span class="line">    labels:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> io.daocloud.dce.version=1.3.2</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.system=build-in</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.controller-ip=138.68.2.15</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.host-address=138.68.2.15</span><br><span class="line"></span></span>    ports:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> 12376:2376</span><br><span class="line"></span></span>    restart: unless-stopped</span><br><span class="line">    volumes:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> /var</span><span class="regexp">/run/docker</span>.<span class="symbol">sock:</span>/var/run/docker.sock</span><br><span class="line"></span>    -<span class="ruby"> /<span class="symbol">sys:</span>/<span class="symbol">sys:</span>ro</span><br><span class="line"></span>    -<span class="ruby"> /<span class="symbol">root:</span>/<span class="symbol">rootdir:</span>rw</span><br><span class="line"></span>  controller:</span><br><span class="line">    depends_on:</span><br><span class="line">    -<span class="ruby"> swarm-manager</span><br><span class="line"></span>    -<span class="ruby"> etcd</span><br><span class="line"></span>    environment:</span><br><span class="line">    -<span class="ruby"> <span class="constant">ETCD_URL</span>=<span class="symbol">etcd:</span>/<span class="regexp">/138.68.2.15:12379</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> CONTROLLER_ADVERTISE=138.68.2.15:80</span><br><span class="line"></span></span>    image: daocloud.io/daocloud/dce-controller:1.3.2</span><br><span class="line">    labels:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> io.daocloud.dce.version=1.3.2</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.system=build-in</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.controller-ip=138.68.2.15</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.host-address=138.68.2.15</span><br><span class="line"></span></span>    ports:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> 80:80</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> 443:443</span><br><span class="line"></span></span>    privileged: true</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    volumes:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> /var</span><span class="regexp">/local/dce</span><span class="regexp">/registry:/var</span><span class="regexp">/lib/registry</span></span><br><span class="line"></span>  etcd:</span><br><span class="line">    command: '--name dce-etcd-138.68.2.15 --data-dir /data '</span><br><span class="line">    environment:</span><br><span class="line">    -<span class="ruby"> <span class="constant">ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="symbol">http:</span>/<span class="regexp">/138.68.2.15:12379</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> ETCD_LISTEN_CLIENT_URLS=http:/</span><span class="regexp">/0.0.0.0:2379</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> ETCD_LISTEN_PEER_URLS=http:/</span><span class="regexp">/0.0.0.0:12380</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> ETCD_INITIAL_ADVERTISE_PEER_URLS=http:/</span><span class="regexp">/138.68.2.15:12380</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> ETCD_CORS=*</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> ETCD_INITIAL_CLUSTER_STATE=new</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> ETCD_INITIAL_CLUSTER=dce-etcd-138.68.2.15=http:/</span><span class="regexp">/138.68.2.15:12380</span><br><span class="line"></span></span>    image: daocloud.io/daocloud/dce-etcd:1.3.2</span><br><span class="line">    labels:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> io.daocloud.dce.version=1.3.2</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.system=build-in</span><br><span class="line"></span></span>    ports:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> 12380:12380</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> 12379:2379</span><br><span class="line"></span></span>    restart: unless-stopped</span><br><span class="line">    volumes:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> /var</span><span class="regexp">/local/dce</span><span class="regexp">/etcd:/data</span></span><br><span class="line"></span>  swarm-manager:</span><br><span class="line">    command: manage --replication --engine-refresh-min-interval 5s --engine-refresh-max-interval</span><br><span class="line">      10s --tls --tlscacert /etc/ssl/private/engine/ca.pem --tlscert /etc/ssl/private/engine/engine-cert.pem</span><br><span class="line">      -<span class="ruby">-tlskey /etc/ssl/private/engine/engine-key.pem <span class="symbol">etcd:</span>/<span class="regexp">/dce_etcd_1:2379</span><br><span class="line"></span></span>    depends_on:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> etcd</span><br><span class="line"></span></span>    environment:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> SWARM_ADVERTISE=138.68.2.15:2375</span><br><span class="line"></span></span>    image: daocloud.io/daocloud/dce-swarm:1.3.2</span><br><span class="line">    labels:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> io.daocloud.dce.version=1.3.2</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.system=build-in</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.controller-ip=138.68.2.15</span><br><span class="line"></span></span>    -<span class="ruby"><span class="regexp"> io.daocloud.dce.host-address=138.68.2.15</span><br><span class="line"></span></span>    ports:</span><br><span class="line">    -<span class="ruby"><span class="regexp"> 2375:2375</span><br><span class="line"></span></span>    restart: unless-stopped</span><br><span class="line">version: '2'</span><br></pre></td></tr></table></figure></p>
<p>agent比我之前猜测的多了个cadvisor</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;DaoCloud是国内领先的容器云，我的山寨容器云需要多向他学习。&lt;br&gt;前几天把环境弄好了，也简单试用了，大概知道DCE技术栈。&lt;br&gt;&lt;a href=&quot;http://blog.decbug.com/2016/07/20/play_dce/&quot;&gt;http://blog.decbug.com/2016/07/20/play_dce/&lt;/a&gt;&lt;br&gt;果然是把docker原生技术发挥到了很棒的境界，很值得学习。&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="DaoCloud" scheme="http://blog.decbug.com/tags/DaoCloud/"/>
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="swarm" scheme="http://blog.decbug.com/tags/swarm/"/>
    
  </entry>
  
  <entry>
    <title>高级docker镜像仓库之删除镜像与恢复镜像</title>
    <link href="http://blog.decbug.com/2016/07/21/del_restore_docker_image/"/>
    <id>http://blog.decbug.com/2016/07/21/del_restore_docker_image/</id>
    <published>2016-07-20T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>看到有容云的AppHouse有删除、恢复镜像的功能，觉得很厉害，打算在我的山寨容器云的仓库上也加上这个功能</p>
<a id="more"></a>
<h1 id="抓包分析有容云"><a href="#抓包分析有容云" class="headerlink" title="抓包分析有容云"></a>抓包分析有容云</h1><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><ol>
<li><p>因为容器间通信肯定会经过docker0，所以抓docker0就够了</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -<span class="tag">i</span> docker0 -w del_restore.cap</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看AppHouse的registry容器的IP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker ps | grep app</span><br><span class="line"><span class="preprocessor"># 得到registry的container ID</span></span><br><span class="line"></span><br><span class="line">docker inspect <span class="number">3</span>a9d50c216de</span><br><span class="line"><span class="preprocessor">#找到IP <span class="string">"IPAddress"</span>: <span class="string">"172.16.52.3"</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wireshark加上条件<code>(ip.src == 172.16.52.3) || (ip.dst == 172.16.52.3) &amp;&amp; tcp.port ==5002 &amp;&amp; http</code></p>
</li>
</ol>
<h2 id="分析包"><a href="#分析包" class="headerlink" title="分析包"></a>分析包</h2><h3 id="获取镜像信息"><a href="#获取镜像信息" class="headerlink" title="获取镜像信息"></a>获取镜像信息</h3><p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/del_image/get.png" alt="get"></p>
<p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/del_image/get_rsp.png" alt="get response"></p>
<p>获取镜像信息，应该是把返回的body都保存下来了</p>
<h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/del_image/del.png" alt="delete"></p>
<p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/del_image/del_rsp.png" alt="delete response"></p>
<p>这个没啥好说</p>
<h3 id="恢复镜像"><a href="#恢复镜像" class="headerlink" title="恢复镜像"></a>恢复镜像</h3><p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/del_image/put.png" alt="put"></p>
<p><img src="https://github.com/CodeJuan/blog/raw/master/source/image/del_image/put_rsp.png" alt="put response"></p>
<p>应该是把之前保存的body又再put进去</p>
<h1 id="官方不建议删除镜像"><a href="#官方不建议删除镜像" class="headerlink" title="官方不建议删除镜像"></a>官方不建议删除镜像</h1><p>因为<a href="https://github.com/docker/distribution/blob/master/ROADMAP.md#deletes" target="_blank" rel="external">https://github.com/docker/distribution/blob/master/ROADMAP.md#deletes</a></p>
<blockquote>
<p>NOTE: Deletes are a much asked for feature. Before requesting this feature or participating in discussion, we ask that you read this section in full and understand the problems behind deletes.</p>
</blockquote>
<p>删除固然简单，删除manifest和blob就行。但是，blob是分层的，可能是多个镜像共用的，如果在删除某个blob的时候，其他人正在使用这个blob，那么就麻烦了。</p>
<h1 id="其实是有删除接口的"><a href="#其实是有删除接口的" class="headerlink" title="其实是有删除接口的"></a>其实是有删除接口的</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DELETE /v2/<span class="tag">&lt;<span class="title">name</span>&gt;</span>/manifests/<span class="tag">&lt;<span class="title">reference</span>&gt;</span></span><br><span class="line">Host: <span class="tag">&lt;<span class="title">registry</span> <span class="attribute">host</span>&gt;</span></span><br><span class="line">Authorization: <span class="tag">&lt;<span class="title">scheme</span>&gt;</span> <span class="tag">&lt;<span class="title">token</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="number">0.1</span></span><br><span class="line"><span class="attribute">log</span>:</span><br><span class="line">  <span class="attribute">fields</span>:</span><br><span class="line">    <span class="attribute">service</span>: registry</span><br><span class="line"><span class="attribute">storage</span>:</span><br><span class="line">    <span class="attribute">cache</span>:</span><br><span class="line">        <span class="attribute">blobdescriptor</span>: inmemory</span><br><span class="line">    <span class="attribute">filesystem</span>:</span><br><span class="line">        <span class="attribute">rootdirectory</span>: /var/lib/registry</span><br><span class="line"># 这里需要把delelte设置为true</span><br><span class="line">    <span class="attribute">delete</span>:</span><br><span class="line">        <span class="attribute">enabled</span>: true</span><br><span class="line"><span class="attribute">http</span>:</span><br><span class="line">    <span class="attribute">addr</span>: :<span class="number">5000</span></span><br><span class="line">    <span class="attribute">headers</span>:</span><br><span class="line">        <span class="attribute">X-Content-Type-Options</span>: [nosniff]</span><br><span class="line"><span class="attribute">health</span>:</span><br><span class="line">  <span class="attribute">storagedriver</span>:</span><br><span class="line">    <span class="attribute">enabled</span>: true</span><br><span class="line">    <span class="attribute">interval</span>: <span class="number">10s</span></span><br><span class="line">    <span class="attribute">threshold</span>: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h1 id="用python写的测试代码"><a href="#用python写的测试代码" class="headerlink" title="用python写的测试代码"></a>用python写的测试代码</h1><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> simplejson <span class="keyword">as</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">registry = <span class="string">"http://192.168.1.245:25678/v2/"</span></span><br><span class="line">image = <span class="string">"test/consul"</span></span><br><span class="line">tag = <span class="string">"latest"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = requests.get(registry + <span class="string">"_catalog/"</span>, verify=<span class="keyword">False</span>)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">'Accept'</span>: <span class="string">'application/vnd.docker.distribution.manifest.v2+json'</span>&#125;</span><br><span class="line">r = requests.get(registry + image + <span class="string">"/manifests/"</span> + tag, headers=headers, verify=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取manifest</span></span><br><span class="line">manifest = r.headers[<span class="string">'Docker-Content-Digest'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"manifest: "</span> + manifest</span><br><span class="line"></span><br><span class="line">data = r.text</span><br><span class="line"><span class="keyword">print</span> data</span><br><span class="line"><span class="comment"># for blob in data['fsLayers']:</span></span><br><span class="line"><span class="comment">#     blob_digest = blob['blobSum']</span></span><br><span class="line"><span class="comment">#     print blob_digest</span></span><br><span class="line"><span class="comment">#     r = requests.delete(registry + "v2/xx/hello/blobs/" + blob_digest, verify=False)</span></span><br><span class="line"><span class="comment">#     print r</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"delete"</span></span><br><span class="line">r = requests.delete(registry + image + <span class="string">"/manifests/"</span> + manifest, verify=<span class="keyword">False</span>)</span><br><span class="line"><span class="keyword">print</span> r.status_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"restore"</span></span><br><span class="line">r = requests.put(registry + image + <span class="string">"/manifests/"</span> + tag, data=data, verify=<span class="keyword">False</span>)</span><br><span class="line"><span class="keyword">print</span> r.status_code</span><br></pre></td></tr></table></figure>
<h1 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h1><img src="http://www.plantuml.com/plantuml/svg/VP3DRW8n38JFpLDOox5QrFCASgWgSU4bdDqXHCeco77uUVkkoa8bG9mi-HjxxE6gETNHGQXPxN9IwdFCidQnmgwSfQybKMDC7mEIjjQpuiGNCzVM2dmeAfUEF9H6Jc67ekRMRkyZ7GcqIlhNt7UeSDbt55A1A8MHFIZnY4zbJvhfZx-o712XU6ScA3K-MnK-uf6rzlfaTmDcO6N71VC1nkKpDJ_V3IssmUzr8rCG7mSM3Nquy9JTLOSqq2Jz1G00">
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;看到有容云的AppHouse有删除、恢复镜像的功能，觉得很厉害，打算在我的山寨容器云的仓库上也加上这个功能&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="image" scheme="http://blog.decbug.com/tags/image/"/>
    
      <category term="registry" scheme="http://blog.decbug.com/tags/registry/"/>
    
  </entry>
  
  <entry>
    <title>看harbor源码</title>
    <link href="http://blog.decbug.com/2016/07/20/inspect_harbor/"/>
    <id>http://blog.decbug.com/2016/07/20/inspect_harbor/</id>
    <published>2016-07-20T12:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>之前自己搞了个玩具registry，没有权限控制，没有角色，没有统计。正好vmware开源了harbor，号称是企业级仓库，我自然是不会放过，要研究一下。</p>
<a id="more"></a>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="官方方法"><a href="#官方方法" class="headerlink" title="官方方法"></a>官方方法</h2><blockquote>
<p>Install Harbor with the following commands. Note that the docker-compose process can take a while.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd Deploy</span><br><span class="line"></span><br><span class="line">$ ./<span class="operator"><span class="keyword">prepare</span></span><br><span class="line"><span class="keyword">Generated</span> configuration <span class="keyword">file</span>: ./config/ui/env</span><br><span class="line"><span class="keyword">Generated</span> configuration <span class="keyword">file</span>: ./config/ui/app.conf</span><br><span class="line"><span class="keyword">Generated</span> configuration <span class="keyword">file</span>: ./config/registry/config.yml</span><br><span class="line"><span class="keyword">Generated</span> configuration <span class="keyword">file</span>: ./config/db/env</span><br><span class="line"></span><br><span class="line">docker-compose up -<span class="keyword">d</span></span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="特殊国情下的模式"><a href="#特殊国情下的模式" class="headerlink" title="特殊国情下的模式"></a>特殊国情下的模式</h2><p>不建议用，最好还是番茄自己build<br>因为Daoloud和CaiCloud的版本都太老，很多新特性都没有。</p>
<h2 id="离线模式"><a href="#离线模式" class="headerlink" title="离线模式"></a>离线模式</h2><p>由于公司坑爹的模式，很多镜像下载不了，只好在家pull下来，然后save成tar，再到公司load<br>具体看这<a href="https://github.com/vmware/harbor/releases/download/0.3.0/harbor-0.3.0.tgz" target="_blank" rel="external">链接</a></p>
<h1 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h1><p><img src="http://dockerone.com/uploads/article/20160331/d9f81c0cdcc4f7b7af42d27d030cf381.png" alt="来自[dockone的架构图](http://dockone.io/article/1179)"></p>
<img src="http://www.plantuml.com/plantuml/svg/oymhIIrAIqnELL1ApibCpIjHKaWiLd3cuaf9B4bCIYm6YljM1XVcA2bKSzLoSQNbvwIa5YaeXNg211I083etCJCl5i9CB2t9W3BpyaioqpAJ4qioyy6oGBtE2hf0yVJCl8fOBYYjeATdfn1Tb9gUMLnIL1chOALGMfJpRCRw1FqoemHKHM1ha1G0fH7wm2h0jWDLbEHdf-PXoA8u2AWAcSyLwWbM1FQfLKeI5nTGDXLeK852VXgI-u3-UDamw_dyfKytR7pQF_5fnmOKKnGKdkwT_79EmujbZIyxjpoRs_ni-ZQWoXSRcfzFMG5o7LTgNWh8ubG0">
<p>我画的架构图</p>
<h1 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h1><p>通过<code>tree -d ./</code>生成，略去部分不重要代码<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">├── api</span><br><span class="line">│   └── jobs</span><br><span class="line">├── auth</span><br><span class="line">│   ├── <span class="keyword">db</span></span><br><span class="line">│   └── ldap</span><br><span class="line">├── contrib</span><br><span class="line">├── controllers</span><br><span class="line">├── dao</span><br><span class="line">├── Deploy</span><br><span class="line">│   ├── config</span><br><span class="line">│   │   ├── <span class="keyword">db</span></span><br><span class="line">│   │   ├── jobservice</span><br><span class="line">│   │   ├── nginx</span><br><span class="line">│   │   │   └── cert</span><br><span class="line">│   │   ├── registry</span><br><span class="line">│   │   └── ui</span><br><span class="line">│   ├── <span class="keyword">db</span></span><br><span class="line">│   ├── kubernetes</span><br><span class="line">│   │   └── dockerfiles</span><br><span class="line">│   ├── <span class="literal">log</span></span><br><span class="line">│   └── templates</span><br><span class="line">│       ├── <span class="keyword">db</span></span><br><span class="line">│       ├── jobservice</span><br><span class="line">│       ├── registry</span><br><span class="line">│       └── ui</span><br><span class="line">├── job</span><br><span class="line">│   ├── config</span><br><span class="line">│   ├── replication</span><br><span class="line">│   └── utils</span><br><span class="line">├── jobservice</span><br><span class="line">├── models</span><br><span class="line">├── service</span><br><span class="line">│   ├── cache</span><br><span class="line">│   ├── <span class="keyword">token</span></span><br><span class="line">│   └── utils</span><br><span class="line">├── static前端</span><br><span class="line">├── tests</span><br><span class="line">├── ui</span><br><span class="line">├── utils共用组件</span><br><span class="line">├── vendor三方库</span><br><span class="line">└── views</span><br></pre></td></tr></table></figure></p>
<p>对应架构图来看</p>
<ul>
<li>proxy就是nginx，<code>Deploy/config/nginx/nginx.conf</code></li>
<li>UI就是<code>ui/main.go</code></li>
<li>token就是<code>service/token/token.go</code></li>
<li>registry的webhook就是<code>Deploy/templates/registry/config.yml</code>的notifications和auth<ul>
<li>auth指向<code>beego.Router(&quot;/service/token&quot;, &amp;token.Handler{})</code>，<code>service/token/token.go</code></li>
<li>notification指向<code>beego.Router(&quot;/service/notifications&quot;, &amp;service.NotificationHandler{})</code>，用来同步备份到远端仓库。<code>service/notification.go</code></li>
</ul>
</li>
<li><code>auth/authenticator.go</code>接口，有本地db和LDAP两种实现，在init时会registrer，根据配置选择用哪个实现。</li>
</ul>
<h1 id="备份策略"><a href="#备份策略" class="headerlink" title="备份策略"></a>备份策略</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/16990645/4d744da8-4ecb-11e6-9f34-b052a0ba5cc6.png" alt=""><br>这个特性很不错啊，registry有了新的更新，就notify到ui的notification，根据配置的策略，是否要备份到远端registry</p>
<h1 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h1><p>用的是open LDAP<br>代码在auth/ldap/ldap.go<br>LDAP_BASE_DN 这个还不会配置</p>
<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>Role Based Access Control<br><code>service/token/authutils.go的FilterAccess</code>，通过token里的scope获取action，再到数据库里查询是否有权限</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;之前自己搞了个玩具registry，没有权限控制，没有角色，没有统计。正好vmware开源了harbor，号称是企业级仓库，我自然是不会放过，要研究一下。&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="harbor" scheme="http://blog.decbug.com/tags/harbor/"/>
    
      <category term="registry" scheme="http://blog.decbug.com/tags/registry/"/>
    
      <category term="vmware" scheme="http://blog.decbug.com/tags/vmware/"/>
    
  </entry>
  
  <entry>
    <title>在家玩DaoCloud企业版</title>
    <link href="http://blog.decbug.com/2016/07/20/play_dce/"/>
    <id>http://blog.decbug.com/2016/07/20/play_dce/</id>
    <published>2016-07-19T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>DaoCloud是国内领先的容器云，我的山寨容器云需要多向他学习。<br>以前只用过公有云版本，大概把持续集成持续交付那一块弄明白了。最近发现有DaoCloud企业版，简称DEC，看了下截图，感觉很不错，决定也自己搞一个玩。</p>
<a id="more"></a>
<h1 id="创建机器"><a href="#创建机器" class="headerlink" title="创建机器"></a>创建机器</h1><p>在DigitalOcean创建两台最低配.</p>
<h1 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h1><h2 id="控制节点"><a href="#控制节点" class="headerlink" title="控制节点"></a>控制节点</h2><p>也就是master<br>一条命令搞定<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash </span>-c <span class="string">"$(docker run -i --rm daocloud.io/daocloud/dce install)"</span></span><br></pre></td></tr></table></figure></p>
<p>竟然内存太小，凑着着用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Verifying System compatibility...</span><br><span class="line">Requirement              Value                          Note</span><br><span class="line">-----------------------  -----------------------------  -------------------------------------------------------</span><br><span class="line">CPU                      <span class="number">1</span>                              Recommended more than <span class="number">4</span> CPU Core.</span><br><span class="line">Memory                   <span class="number">489.9921875</span> MiB                WARN: Should be installed where more than <span class="number">1</span>G memory.</span><br><span class="line">Storage For Docker       <span class="number">16.7933425903</span> GiB              Recommended more than <span class="number">30</span>GB.</span><br><span class="line">Network to Controller    OK                             OK</span><br><span class="line">Network from Controller  OK                             OK</span><br><span class="line">Operating System         Ubuntu <span class="number">14.04</span><span class="number">.4</span> LTS             WARN: Recommended Ubuntu <span class="number">16.04</span>.</span><br><span class="line">Linux Kernel             <span class="number">3.13</span><span class="number">.0</span>-<span class="number">85</span>-generic              Recommended the latest maintained version Linux kernel.</span><br><span class="line">Docker Version           <span class="number">1.11</span><span class="number">.2</span>                         OK</span><br><span class="line">Docker Storage Driver    aufs                           OK</span><br><span class="line">Docker Feature           All Supported                  OK</span><br><span class="line">Docker ID                MIM2:DL6F:WVJN:UDDF:...        OK</span><br><span class="line">Firewalld                UnKnown                        Make sure the firewalld has been closed.</span><br><span class="line">Host Name                docker-<span class="number">512</span>mb-sfo2-<span class="number">01</span>           OK</span><br><span class="line">Port                     <span class="number">80</span>,<span class="number">443</span>,<span class="number">2375</span>,<span class="number">12376</span>,<span class="number">12380</span>,<span class="number">12379</span>  OK</span><br><span class="line">Time                     <span class="number">0</span>ms                            OK</span><br><span class="line">SELinux                  permissive                     SELinux has been disabled.</span><br></pre></td></tr></table></figure></p>
<h2 id="容器节点"><a href="#容器节点" class="headerlink" title="容器节点"></a>容器节点</h2><p>也就是slave<br>看起来像是swarm join<br>在另一台机器上运行</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash </span>-c <span class="string">"$(docker run -i --rm daocloud.io/daocloud/dce join &#123;你的控制器IP&#125;)"</span></span><br></pre></td></tr></table></figure>
<h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p><img src="https://cloud.githubusercontent.com/assets/5423628/16971073/34dce8c2-4e53-11e6-8e40-1dd8e292dcfa.png" alt="image"><br><img src="https://cloud.githubusercontent.com/assets/5423628/16971113/921cf004-4e53-11e6-8c9f-02c7eaca1105.png" alt="image"></p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;DaoCloud是国内领先的容器云，我的山寨容器云需要多向他学习。&lt;br&gt;以前只用过公有云版本，大概把持续集成持续交付那一块弄明白了。最近发现有DaoCloud企业版，简称DEC，看了下截图，感觉很不错，决定也自己搞一个玩。&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="DaoCloud" scheme="http://blog.decbug.com/tags/DaoCloud/"/>
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="swarm" scheme="http://blog.decbug.com/tags/swarm/"/>
    
  </entry>
  
  <entry>
    <title>net-speeder番茄加速</title>
    <link href="http://blog.decbug.com/2016/07/15/net_speeder/"/>
    <id>http://blog.decbug.com/2016/07/15/net_speeder/</id>
    <published>2016-07-14T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.866Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>由于流量不够用，又买了个廉价vps，3年只要8刀，64M内存，1G硬盘，250M流量。<br>由于配置比较差，且机房离大陆远，ping有300多ms，看youtube略卡，只好使用net-speeder</p>
<a id="more"></a>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#安装libnet-<span class="built_in">dev</span>：</span><br><span class="line">apt-<span class="built_in">get</span> install libnet1-<span class="built_in">dev</span></span><br><span class="line">#安装libpcap-<span class="built_in">dev</span>：</span><br><span class="line">apt-<span class="built_in">get</span> install libpcap0<span class="number">.8</span>-<span class="built_in">dev</span></span><br></pre></td></tr></table></figure>
<h2 id="安装net-speeder"><a href="#安装net-speeder" class="headerlink" title="安装net-speeder"></a>安装net-speeder</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//github.com/snooda/net-speeder/archive/master.zip</span></span><br><span class="line">unzip master.<span class="keyword">zip</span></span><br><span class="line"><span class="keyword">cd</span> <span class="keyword">net</span>-speeder-master</span><br><span class="line"># openvz 用这个命令make</span><br><span class="line"><span class="keyword">sh</span> build.<span class="keyword">sh</span> -DCOOKED</span><br></pre></td></tr></table></figure>
<h2 id="添加开机启动"><a href="#添加开机启动" class="headerlink" title="添加开机启动"></a>添加开机启动</h2><p>打开/etc/local.rc，加上<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[net_speeder安装目录]</span>/net_speeder venet0:<span class="number">0</span> <span class="string">"ip"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h1><p>不知是不算心理作用，果然不那么卡了</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;由于流量不够用，又买了个廉价vps，3年只要8刀，64M内存，1G硬盘，250M流量。&lt;br&gt;由于配置比较差，且机房离大陆远，ping有300多ms，看youtube略卡，只好使用net-speeder&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="番茄" scheme="http://blog.decbug.com/tags/%E7%95%AA%E8%8C%84/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes:pod内IPC</title>
    <link href="http://blog.decbug.com/2016/07/03/docker_kubernetes_IPC_pod/"/>
    <id>http://blog.decbug.com/2016/07/03/docker_kubernetes_IPC_pod/</id>
    <published>2016-07-02T16:00:00.000Z</published>
    <updated>2016-10-17T00:03:31.862Z</updated>
    
    <content type="html"><![CDATA[<p>要动态更新容器里某些进程的配置，例如nginx。所以需要实时获取配置更新，并同步到容器里的配置文件里，采用的方法是用confd从etcd采集数据，然后更新配置文件的方法。<br>现有的方案是把confd+nginx放在同一个容器里，虽然能解决问题，但是不够优雅，毕竟一个容器只跑一个进程好。<br>恰好业务是跑在k8s上，k8s关于pod的文档上说</p>
<blockquote>
<p>Containers within a pod share an IP address and port space, and can find each other via localhost. They can also communicate with each other using standard inter-process communications like SystemV semaphores or POSIX shared memory. Containers in different pods have distinct IP addresses and can not communicate by IPC</p>
</blockquote>
<p>如果同一个pod里的进程，可以互相看到对方，那么就可以不用修改，直接把现有一个容器拆成两个容器了。</p>
<a id="more"></a>
<p>提前剧透一下结论，是看不到的。因为</p>
<blockquote>
<p>The context of the pod can be defined as the conjunction of several Linux namespaces:</p>
<ul>
<li>PID namespace (applications within the pod can see each other’s processes)</li>
<li>network namespace (applications within the pod have access to the same IP and port space)</li>
<li>IPC namespace (applications within the pod can use SystemV IPC or POSIX message queues to communicate)</li>
<li>UTS namespace (applications within the pod share a hostname)</li>
</ul>
<p>In terms of Docker constructs, a pod consists of a colocated group of Docker containers with shared volumes. PID namespace sharing is not yet implemented with Docker.</p>
</blockquote>
<h1 id="创建pod"><a href="#创建pod" class="headerlink" title="创建pod"></a>创建pod</h1><p>创建两个容器的pod<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Pod</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: ipc2</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: web</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">containers</span>:</span><br><span class="line">    - <span class="attribute">name</span>: registry</span><br><span class="line">      <span class="attribute">image</span>: registry</span><br><span class="line">      <span class="attribute">ports</span>:</span><br><span class="line">        - <span class="attribute">containerPort</span>: <span class="number">5000</span></span><br><span class="line">    - <span class="attribute">name</span>: nginx</span><br><span class="line">      <span class="attribute">image</span>: <span class="attribute">nginx</span>:<span class="number">1.9</span></span><br><span class="line">      <span class="attribute">ports</span>:</span><br><span class="line">        - <span class="attribute">containerPort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<h1 id="进入其中一个ps和netstat"><a href="#进入其中一个ps和netstat" class="headerlink" title="进入其中一个ps和netstat"></a>进入其中一个ps和netstat</h1><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">./<span class="tag">kubectl</span> <span class="tag">exec</span> <span class="tag">-it</span> <span class="tag">ipc2</span> <span class="tag">bash</span></span><br><span class="line"></span><br><span class="line"># 看进程</span><br><span class="line"><span class="tag">ps</span> <span class="tag">aux</span></span><br><span class="line"># 结果，只能看到<span class="tag">registry</span>的进程</span><br><span class="line"><span class="tag">USER</span>       <span class="tag">PID</span> %<span class="tag">CPU</span> %<span class="tag">MEM</span>    <span class="tag">VSZ</span>   <span class="tag">RSS</span> <span class="tag">TTY</span>      <span class="tag">STAT</span> <span class="tag">START</span>   <span class="tag">TIME</span> <span class="tag">COMMAND</span></span><br><span class="line"><span class="tag">root</span>         <span class="tag">1</span>  <span class="tag">0</span><span class="class">.0</span>  <span class="tag">0</span><span class="class">.4</span>  <span class="tag">53228</span> <span class="tag">15992</span> ?        <span class="tag">Ss</span>   <span class="tag">14</span><span class="pseudo">:56</span>   <span class="tag">0</span><span class="pseudo">:00</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">13</span>  <span class="tag">1</span><span class="class">.0</span>  <span class="tag">1</span><span class="class">.0</span> <span class="tag">110492</span> <span class="tag">39600</span> ?        <span class="tag">S</span>    <span class="tag">14</span><span class="pseudo">:56</span>   <span class="tag">0</span><span class="pseudo">:03</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">14</span>  <span class="tag">1</span><span class="class">.0</span>  <span class="tag">0</span><span class="class">.9</span> <span class="tag">110256</span> <span class="tag">38804</span> ?        <span class="tag">S</span>    <span class="tag">14</span><span class="pseudo">:56</span>   <span class="tag">0</span><span class="pseudo">:03</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">17</span>  <span class="tag">0</span><span class="class">.9</span>  <span class="tag">0</span><span class="class">.9</span> <span class="tag">110272</span> <span class="tag">38820</span> ?        <span class="tag">S</span>    <span class="tag">14</span><span class="pseudo">:56</span>   <span class="tag">0</span><span class="pseudo">:03</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">18</span>  <span class="tag">1</span><span class="class">.0</span>  <span class="tag">0</span><span class="class">.9</span> <span class="tag">110276</span> <span class="tag">38816</span> ?        <span class="tag">S</span>    <span class="tag">14</span><span class="pseudo">:56</span>   <span class="tag">0</span><span class="pseudo">:03</span> /<span class="tag">usr</span>/<span class="tag">bin</span>/<span class="tag">python</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">44</span>  <span class="tag">0</span><span class="class">.0</span>  <span class="tag">0</span><span class="class">.0</span>  <span class="tag">18148</span>  <span class="tag">3364</span> ?        <span class="tag">Ss</span>+  <span class="tag">15</span><span class="pseudo">:00</span>   <span class="tag">0</span><span class="pseudo">:00</span> <span class="tag">bash</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">60</span>  <span class="tag">2</span><span class="class">.0</span>  <span class="tag">0</span><span class="class">.0</span>  <span class="tag">18152</span>  <span class="tag">3192</span> ?        <span class="tag">Ss</span>   <span class="tag">15</span><span class="pseudo">:01</span>   <span class="tag">0</span><span class="pseudo">:00</span> <span class="tag">bash</span></span><br><span class="line"><span class="tag">root</span>        <span class="tag">74</span>  <span class="tag">0</span><span class="class">.0</span>  <span class="tag">0</span><span class="class">.0</span>  <span class="tag">15572</span>  <span class="tag">2164</span> ?        <span class="tag">R</span>+   <span class="tag">15</span><span class="pseudo">:01</span>   <span class="tag">0</span><span class="pseudo">:00</span> <span class="tag">ps</span> <span class="tag">aux</span></span><br><span class="line"></span><br><span class="line"># 看端口</span><br><span class="line"><span class="tag">root</span>@<span class="tag">ipc2</span>:/# <span class="tag">netstat</span> <span class="tag">-anplt</span></span><br><span class="line"># 结果，网络共享了</span><br><span class="line"><span class="tag">Active</span> <span class="tag">Internet</span> <span class="tag">connections</span> (servers and established)</span><br><span class="line"><span class="tag">Proto</span> <span class="tag">Recv-Q</span> <span class="tag">Send-Q</span> <span class="tag">Local</span> <span class="tag">Address</span>           <span class="tag">Foreign</span> <span class="tag">Address</span>         <span class="tag">State</span>       <span class="tag">PID</span>/<span class="tag">Program</span> <span class="tag">name</span></span><br><span class="line"><span class="tag">tcp</span>        <span class="tag">0</span>      <span class="tag">0</span> <span class="tag">0</span><span class="class">.0</span><span class="class">.0</span><span class="class">.0</span><span class="pseudo">:5000</span>            <span class="tag">0</span><span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*               <span class="tag">LISTEN</span>      <span class="tag">-</span></span><br><span class="line"><span class="tag">tcp</span>        <span class="tag">0</span>      <span class="tag">0</span> <span class="tag">0</span><span class="class">.0</span><span class="class">.0</span><span class="class">.0</span><span class="pseudo">:80</span>              <span class="tag">0</span><span class="class">.0</span><span class="class">.0</span><span class="class">.0</span>:*               <span class="tag">LISTEN</span>      <span class="tag">-</span></span><br></pre></td></tr></table></figure>
<h1 id="进入另一个容器"><a href="#进入另一个容器" class="headerlink" title="进入另一个容器"></a>进入另一个容器</h1><p>进入nginx容器看看进程<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it k8s_nginx.fb0f31c6_ipc2_default_82fd2fb7-<span class="number">42</span>c0-<span class="number">11e6</span>-a4f1-d43d7e2c2527_c689aa68 bash</span><br><span class="line">root@ipc2:/<span class="preprocessor"># ps axu</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># 只能看到nginx的进程</span></span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root         <span class="number">1</span>  <span class="number">0.0</span>  <span class="number">0.1</span>  <span class="number">31684</span>  <span class="number">5100</span> ?        Ss   <span class="number">14</span>:<span class="number">57</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process nginx -g daemon off;</span><br><span class="line">nginx        <span class="number">5</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">32068</span>  <span class="number">2904</span> ?        S    <span class="number">14</span>:<span class="number">57</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">root         <span class="number">6</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">20224</span>  <span class="number">3272</span> ?        Ss   <span class="number">15</span>:<span class="number">00</span>   <span class="number">0</span>:<span class="number">00</span> bash</span><br><span class="line">root        <span class="number">19</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">17500</span>  <span class="number">2096</span> ?        R+   <span class="number">15</span>:<span class="number">09</span>   <span class="number">0</span>:<span class="number">00</span> ps axu</span><br></pre></td></tr></table></figure></p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>网络、UTC、IPC都共享，但是PID不能共享。</p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;要动态更新容器里某些进程的配置，例如nginx。所以需要实时获取配置更新，并同步到容器里的配置文件里，采用的方法是用confd从etcd采集数据，然后更新配置文件的方法。&lt;br&gt;现有的方案是把confd+nginx放在同一个容器里，虽然能解决问题，但是不够优雅，毕竟一个容器只跑一个进程好。&lt;br&gt;恰好业务是跑在k8s上，k8s关于pod的文档上说&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Containers within a pod share an IP address and port space, and can find each other via localhost. They can also communicate with each other using standard inter-process communications like SystemV semaphores or POSIX shared memory. Containers in different pods have distinct IP addresses and can not communicate by IPC&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;如果同一个pod里的进程，可以互相看到对方，那么就可以不用修改，直接把现有一个容器拆成两个容器了。&lt;/p&gt;
    
    </summary>
    
      <category term="code" scheme="http://blog.decbug.com/categories/code/"/>
    
    
      <category term="docker" scheme="http://blog.decbug.com/tags/docker/"/>
    
      <category term="kubernetes" scheme="http://blog.decbug.com/tags/kubernetes/"/>
    
  </entry>
  
</feed>
