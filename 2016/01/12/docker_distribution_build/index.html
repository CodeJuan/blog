<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>




  <meta name="keywords" content="docker,docker-distribution,docker-registry," />



  <link rel="alternate" href="/atom.xml" title="Continuous Learning" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="背景关于registry的基本知识已经了解差不多了，现在开始搭建一个可用的私有registry">
<meta property="og:type" content="article">
<meta property="og:title" content="docker(3)-搭建registry,nginx,mirror">
<meta property="og:url" content="http://blog.decbug.com/2016/01/12/docker_distribution_build/index.html">
<meta property="og:site_name" content="Continuous Learning">
<meta property="og:description" content="背景关于registry的基本知识已经了解差不多了，现在开始搭建一个可用的私有registry">
<meta property="og:image" content="http://dockerone.com/uploads/article/20150512/1e111941614512fcc0bdeb2e80ee9384.png">
<meta property="og:updated_time" content="2016-02-18T00:07:43.666Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="docker(3)-搭建registry,nginx,mirror">
<meta name="twitter:description" content="背景关于registry的基本知识已经了解差不多了，现在开始搭建一个可用的私有registry">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'always'
  };
</script>

  <title> docker(3)-搭建registry,nginx,mirror | Continuous Learning </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-57346409-1', 'auto');
  ga('send', 'pageview');
</script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Continuous Learning</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-twitter">
          <a href="/twitter" rel="section">
            <i class="menu-item-icon icon-next-twitter"></i> <br />
            碎碎念
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/book" rel="section">
            <i class="menu-item-icon icon-next-book"></i> <br />
            书单
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            <i class="menu-item-icon icon-next-commonweal"></i> <br />
            404
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'ahcnzwTk9sEy9JreBfZC','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              docker(3)-搭建registry,nginx,mirror
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2016-01-12T00:00:00+08:00" content="2016-01-12">
            2016-01-12
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/code/" itemprop="url" rel="index">
                  <span itemprop="name">code</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2016/01/12/docker_distribution_build/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/12/docker_distribution_build/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h1 id="背景">背景</h1><p>关于registry的基本知识已经了解差不多了，现在开始搭建一个可用的私有registry<br><a id="more"></a></p>
<h1 id="架构">架构</h1><p><img src="http://dockerone.com/uploads/article/20150512/1e111941614512fcc0bdeb2e80ee9384.png" alt=""></p>
<p>就采用<a href="http://dockone.io/people/%E9%9A%BE%E6%98%93" target="_blank" rel="external">钟成</a>提到的架构</p>
<h1 id="进展1">进展1</h1><p>搭建了registry+front，配置了https<br>折腾一天，累成狗了，不详细写拉。直接看代码吧，都写成脚本和compose了<br><a href="https://github.com/CodeJuan/private_registry" target="_blank" rel="external">https://github.com/CodeJuan/private_registry</a></p>
<h1 id="进展2:registry集群">进展2:registry集群</h1><p>实现了负载均衡<br>用的是nginx1.9的镜像<br><a href="https://github.com/CodeJuan/private_registry/commit/7233fbf7def7b32daccc065f6ef546b234606e0d" target="_blank" rel="external">https://github.com/CodeJuan/private_registry/commit/7233fbf7def7b32daccc065f6ef546b234606e0d</a></p>
<h1 id="进展3:后端存储">进展3:后端存储</h1><p>后端存储采用的是某共享存储技术，所有的registry都访问同一个存储集群，路径都一样</p>
<h1 id="进展4：mirror">进展4：mirror</h1><blockquote>
<p>If you have multiple instances of Docker running in your environment (e.g., multiple physical or virtual machines, all running the Docker daemon), each time one of them requires an image that it doesn’t have it will go out to the internet and fetch it from the public Docker registry. By running a local registry mirror, you can keep most of the redundant image fetch traffic on your local network.</p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mirror</span>:</span><br><span class="line">  <span class="attribute">restart</span>: always</span><br><span class="line">  <span class="attribute">image</span>: <span class="attribute">registry</span>:<span class="number">2.2</span>.<span class="number">1</span></span><br><span class="line">  <span class="attribute">volumes</span>:</span><br><span class="line">    - ./<span class="attribute">mirror</span>:/var/lib/registry</span><br><span class="line">  <span class="attribute">environment</span>:</span><br><span class="line">    <span class="attribute">STANDALONE</span>: <span class="string">'false'</span></span><br><span class="line">    <span class="attribute">MIRROR_SOURCE</span>: <span class="attribute">https</span>:<span class="comment">//registry-1.docker.io</span></span><br><span class="line">    <span class="attribute">MIRROR_SOURCE_INDEX</span>: <span class="attribute">https</span>:<span class="comment">//index.docker.io registry</span></span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">   - <span class="number">5555</span>:<span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h2 id="第一次pull">第一次pull</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">docker</span> <span class="tag">pull</span> <span class="tag">django</span></span><br><span class="line">0<span class="class">.19user</span> 0<span class="class">.06system</span> 9<span class="pseudo">:16</span><span class="class">.60elapsed</span> 0%<span class="tag">CPU</span> (0<span class="tag">avgtext</span>+0<span class="tag">avgdata</span> 26432<span class="tag">maxresident</span>)<span class="tag">k</span></span><br></pre></td></tr></table></figure>
<p>mirror log<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">time=<span class="string">"2016-01-22T13:15:27Z"</span> level=info msg=<span class="string">"response completed"</span> go.version=go1.<span class="number">5.2</span> http<span class="class">.request</span><span class="class">.host</span>=<span class="string">"docker-hub.mymirror.com:5555"</span> http<span class="class">.request</span><span class="class">.id</span>=<span class="number">884</span>f518d-f69c-<span class="number">4</span>d7d-<span class="number">8189</span>-<span class="number">0</span>afb70d1f351 http<span class="class">.request</span><span class="class">.method</span>=GET http<span class="class">.request</span><span class="class">.remoteaddr</span>=<span class="string">"192.168.1.245:54369"</span> http<span class="class">.request</span><span class="class">.uri</span>=<span class="string">"//v2/"</span> http<span class="class">.request</span><span class="class">.useragent</span>=<span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span> http<span class="class">.response</span><span class="class">.duration</span>=<span class="string">"142.245µs"</span> http<span class="class">.response</span><span class="class">.status</span>=<span class="number">301</span> http<span class="class">.response</span><span class="class">.written</span>=<span class="number">0</span> instance.id=<span class="number">3</span>d1817be-d0b8-<span class="number">4</span>c98-<span class="number">8560</span>-fe88c5039957 version=v2.<span class="number">2.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.245</span> - - [<span class="number">22</span>/Jan/<span class="number">2016</span>:<span class="number">13</span>:<span class="number">15</span>:<span class="number">27</span> +<span class="number">0000</span>] <span class="string">"GET //v2/ HTTP/1.1"</span> <span class="number">301</span> <span class="number">0</span> <span class="string">""</span> <span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span></span><br><span class="line">time=<span class="string">"2016-01-22T13:15:27Z"</span> level=info msg=<span class="string">"response completed"</span> go.version=go1.<span class="number">5.2</span> http<span class="class">.request</span><span class="class">.host</span>=<span class="string">"docker-hub.mymirror.com:5555"</span> http<span class="class">.request</span><span class="class">.id</span>=d38c459d-b0e8-<span class="number">4</span>e40-<span class="number">9991</span>-<span class="number">537999</span>b206ca http<span class="class">.request</span><span class="class">.method</span>=GET http<span class="class">.request</span><span class="class">.referer</span>=<span class="string">"http://docker-hub.mymirror.com:5555//v2/"</span> http<span class="class">.request</span><span class="class">.remoteaddr</span>=<span class="string">"192.168.1.245:54370"</span> http<span class="class">.request</span><span class="class">.uri</span>=<span class="string">"/v2/"</span> http<span class="class">.request</span><span class="class">.useragent</span>=<span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span> http<span class="class">.response</span><span class="class">.contenttype</span>=<span class="string">"application/json; charset=utf-8"</span> http<span class="class">.response</span><span class="class">.duration</span>=<span class="number">4.311715ms</span> http<span class="class">.response</span><span class="class">.status</span>=<span class="number">200</span> http<span class="class">.response</span><span class="class">.written</span>=<span class="number">2</span> instance.id=<span class="number">3</span>d1817be-d0b8-<span class="number">4</span>c98-<span class="number">8560</span>-fe88c5039957 version=v2.<span class="number">2.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.245</span> - - [<span class="number">22</span>/Jan/<span class="number">2016</span>:<span class="number">13</span>:<span class="number">15</span>:<span class="number">27</span> +<span class="number">0000</span>] <span class="string">"GET /v2/ HTTP/1.1"</span> <span class="number">200</span> <span class="number">2</span> <span class="string">"http://docker-hub.mymirror.com:5555//v2/"</span> <span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span></span><br><span class="line">time=<span class="string">"2016-01-22T13:15:27Z"</span> level=error msg=<span class="string">"response completed with error"</span> err.code=<span class="string">"MANIFEST_UNKNOWN"</span> err.detail=<span class="string">"unknown manifest name=library/django tag=latest"</span> err.message=<span class="string">"manifest unknown"</span> go.version=go1.<span class="number">5.2</span> http<span class="class">.request</span><span class="class">.host</span>=<span class="string">"docker-hub.mymirror.com:5555"</span> http<span class="class">.request</span><span class="class">.id</span>=<span class="number">6</span>c236f9c-<span class="number">53</span>e9-<span class="number">4</span>f4a-b61a-bf90e61c4c95 http<span class="class">.request</span><span class="class">.method</span>=GET http<span class="class">.request</span><span class="class">.remoteaddr</span>=<span class="string">"192.168.1.245:54371"</span> http<span class="class">.request</span><span class="class">.uri</span>=<span class="string">"/v2/library/django/manifests/latest"</span> http<span class="class">.request</span><span class="class">.useragent</span>=<span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span> http<span class="class">.response</span><span class="class">.contenttype</span>=<span class="string">"application/json; charset=utf-8"</span> http<span class="class">.response</span><span class="class">.duration</span>=<span class="number">4.919044ms</span> http<span class="class">.response</span><span class="class">.status</span>=<span class="number">404</span> http<span class="class">.response</span><span class="class">.written</span>=<span class="number">120</span> instance.id=<span class="number">3</span>d1817be-d0b8-<span class="number">4</span>c98-<span class="number">8560</span>-fe88c5039957 vars.name=<span class="string">"library/django"</span> vars.reference=latest version=v2.<span class="number">2.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.245</span> - - [<span class="number">22</span>/Jan/<span class="number">2016</span>:<span class="number">13</span>:<span class="number">15</span>:<span class="number">27</span> +<span class="number">0000</span>] <span class="string">"GET /v2/library/django/manifests/latest HTTP/1.1"</span> <span class="number">404</span> <span class="number">120</span> <span class="string">""</span> <span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="rmi_django再次pull">rmi django再次pull</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">docker</span> <span class="tag">pull</span> <span class="tag">django</span></span><br><span class="line">0<span class="class">.21user</span> 0<span class="class">.05system</span> 13<span class="pseudo">:35</span><span class="class">.23elapsed</span> 0%<span class="tag">CPU</span> (0<span class="tag">avgtext</span>+0<span class="tag">avgdata</span> 27152<span class="tag">maxresident</span>)<span class="tag">k</span></span><br></pre></td></tr></table></figure>
<p>时间还变长了</p>
<p>mirror log<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">time=<span class="string">"2016-01-22T13:36:29Z"</span> level=info msg=<span class="string">"response completed"</span> go.version=go1.<span class="number">5.2</span> http<span class="class">.request</span><span class="class">.host</span>=<span class="string">"docker-hub.mymirror.com:5555"</span> http<span class="class">.request</span><span class="class">.id</span>=<span class="number">5317</span>fae0-<span class="number">9</span>ead-<span class="number">4</span>bc4-a016-<span class="number">3</span>df313f7873a http<span class="class">.request</span><span class="class">.method</span>=GET http<span class="class">.request</span><span class="class">.remoteaddr</span>=<span class="string">"192.168.1.245:54431"</span> http<span class="class">.request</span><span class="class">.uri</span>=<span class="string">"//v2/"</span> http<span class="class">.request</span><span class="class">.useragent</span>=<span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span> http<span class="class">.response</span><span class="class">.duration</span>=<span class="string">"126.687µs"</span> http<span class="class">.response</span><span class="class">.status</span>=<span class="number">301</span> http<span class="class">.response</span><span class="class">.written</span>=<span class="number">0</span> instance.id=<span class="number">3</span>d1817be-d0b8-<span class="number">4</span>c98-<span class="number">8560</span>-fe88c5039957 version=v2.<span class="number">2.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.245</span> - - [<span class="number">22</span>/Jan/<span class="number">2016</span>:<span class="number">13</span>:<span class="number">36</span>:<span class="number">29</span> +<span class="number">0000</span>] <span class="string">"GET //v2/ HTTP/1.1"</span> <span class="number">301</span> <span class="number">0</span> <span class="string">""</span> <span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span></span><br><span class="line">time=<span class="string">"2016-01-22T13:36:29Z"</span> level=info msg=<span class="string">"response completed"</span> go.version=go1.<span class="number">5.2</span> http<span class="class">.request</span><span class="class">.host</span>=<span class="string">"docker-hub.mymirror.com:5555"</span> http<span class="class">.request</span><span class="class">.id</span>=<span class="number">86</span>ed3aa8-a2ec-<span class="number">4</span>b88-<span class="number">8</span>a28-adcd4780ef78 http<span class="class">.request</span><span class="class">.method</span>=GET http<span class="class">.request</span><span class="class">.referer</span>=<span class="string">"http://docker-hub.mymirror.com:5555//v2/"</span> http<span class="class">.request</span><span class="class">.remoteaddr</span>=<span class="string">"192.168.1.245:54432"</span> http<span class="class">.request</span><span class="class">.uri</span>=<span class="string">"/v2/"</span> http<span class="class">.request</span><span class="class">.useragent</span>=<span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span> http<span class="class">.response</span><span class="class">.contenttype</span>=<span class="string">"application/json; charset=utf-8"</span> http<span class="class">.response</span><span class="class">.duration</span>=<span class="number">4.279031ms</span> http<span class="class">.response</span><span class="class">.status</span>=<span class="number">200</span> http<span class="class">.response</span><span class="class">.written</span>=<span class="number">2</span> instance.id=<span class="number">3</span>d1817be-d0b8-<span class="number">4</span>c98-<span class="number">8560</span>-fe88c5039957 version=v2.<span class="number">2.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.245</span> - - [<span class="number">22</span>/Jan/<span class="number">2016</span>:<span class="number">13</span>:<span class="number">36</span>:<span class="number">29</span> +<span class="number">0000</span>] <span class="string">"GET /v2/ HTTP/1.1"</span> <span class="number">200</span> <span class="number">2</span> <span class="string">"http://docker-hub.mymirror.com:5555//v2/"</span> <span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span></span><br><span class="line">time=<span class="string">"2016-01-22T13:36:29Z"</span> level=error msg=<span class="string">"response completed with error"</span> err.code=<span class="string">"MANIFEST_UNKNOWN"</span> err.detail=<span class="string">"unknown manifest name=library/django tag=latest"</span> err.message=<span class="string">"manifest unknown"</span> go.version=go1.<span class="number">5.2</span> http<span class="class">.request</span><span class="class">.host</span>=<span class="string">"docker-hub.mymirror.com:5555"</span> http<span class="class">.request</span><span class="class">.id</span>=<span class="number">2097</span>bff1-<span class="number">98</span>f8-<span class="number">443</span>b-<span class="number">9</span>e6d-<span class="number">9</span>c4b93d0c87f http<span class="class">.request</span><span class="class">.method</span>=GET http<span class="class">.request</span><span class="class">.remoteaddr</span>=<span class="string">"192.168.1.245:54433"</span> http<span class="class">.request</span><span class="class">.uri</span>=<span class="string">"/v2/library/django/manifests/latest"</span> http<span class="class">.request</span><span class="class">.useragent</span>=<span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span> http<span class="class">.response</span><span class="class">.contenttype</span>=<span class="string">"application/json; charset=utf-8"</span> http<span class="class">.response</span><span class="class">.duration</span>=<span class="number">4.300812ms</span> http<span class="class">.response</span><span class="class">.status</span>=<span class="number">404</span> http<span class="class">.response</span><span class="class">.written</span>=<span class="number">120</span> instance.id=<span class="number">3</span>d1817be-d0b8-<span class="number">4</span>c98-<span class="number">8560</span>-fe88c5039957 vars.name=<span class="string">"library/django"</span> vars.reference=latest version=v2.<span class="number">2.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.245</span> - - [<span class="number">22</span>/Jan/<span class="number">2016</span>:<span class="number">13</span>:<span class="number">36</span>:<span class="number">29</span> +<span class="number">0000</span>] <span class="string">"GET /v2/library/django/manifests/latest HTTP/1.1"</span> <span class="number">404</span> <span class="number">120</span> <span class="string">""</span> <span class="string">"docker/1.9.1 go/go1.4.2 git-commit/a34a1d5 kernel/3.19.0-25-generic os/linux arch/amd64"</span></span><br></pre></td></tr></table></figure></p>
<p>奇怪</p>
<p>更新，搞定了，原因是在compose里写环境变量不管用，等在config.yml里加上proxy，参见<br><a href="https://github.com/CodeJuan/private_registry/blob/master/mirror_config.yml" target="_blank" rel="external">https://github.com/CodeJuan/private_registry/blob/master/mirror_config.yml</a></p>
<h1 id="进展5：调通删除镜像API">进展5：调通删除镜像API</h1><p>I sent the same request with @adolphlwq ‘s request, and got the same response<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">curl</span> -v -X DELETE http://myregistry/<span class="literal">v2</span>/<span class="keyword">busybox/manifests/sha256:blablabla...</span><br><span class="line"></span></span><br><span class="line">&#123;<span class="string">"errors"</span>:[&#123;<span class="string">"code"</span>:<span class="string">"UNSUPPORTED"</span>,<span class="string">"message"</span>:<span class="string">"The operation is unsupported."</span>&#125;]&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="update">update</h2><p>I got the solution to delete images</p>
<h3 id="enable_delete">enable delete</h3><p> set the environment variable <code>REGISTRY_STORAGE_DELETE_ENABLED = True</code></p>
<h3 id="the_API_to_delete_image">the API to delete image</h3><ol>
<li>get the manifest from registry<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get v2/<span class="tag">&lt;<span class="title">repoName</span>&gt;</span>/manifests/<span class="tag">&lt;<span class="title">tagName</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>the <code>Docker-Content-Digest</code> is response.Header[“Docker-Content-Digest”]<br>the <code>layerDigests</code> is response.body[“fsLayers”][“blobSum”]</p>
<ol>
<li><p>delete layerDigests</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete v2/<span class="tag">&lt;<span class="title">repoName</span>&gt;</span>/blobs/<span class="tag">&lt;<span class="title">layerDigests</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>delete Docker-Content-Digest</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete v2/<span class="tag">&lt;<span class="title">repoName</span>&gt;</span>/manifests/<span class="tag">&lt;<span class="title">Docker-Content-Digest</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>then pull the image from registry, the response is <code>invalid character &#39;&lt;&#39; looking for beginning of value</code></p>
</li>
</ol>
<p>But when I get ‘v2/repoName/tags/list’, the tag which was been deleted is still exist…….</p>
<h1 id="参考">参考</h1><p><a href="http://www.mworks92.com/2016/01/13/secure-registry-test/" target="_blank" rel="external">关于私有安全docker registry的实验</a><br><a href="http://blog.gesha.net/archives/613/" target="_blank" rel="external">搭建Docker私有仓库Registry-v2</a></p>
<hr>
<p><code>本博客欢迎转发,但请保留原作者信息</code><br>github:<a href="https://github.com/CodeJuan" target="_blank" rel="external">codejuan</a><br>博客地址:<a href="http://blog.decbug.com/">http://blog.decbug.com/</a></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/docker/" rel="tag">#docker</a>
          
            <a href="/tags/docker-distribution/" rel="tag">#docker-distribution</a>
          
            <a href="/tags/docker-registry/" rel="tag">#docker-registry</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/01/13/docker_distribution_nexus/" rel="prev">docker(4)-nexus3</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/01/12/docker_distribution/" rel="next">docker(3)-distribution分析</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://avatars3.githubusercontent.com/u/5423628?v=3&s=460" alt="CodeJuan" itemprop="image"/>
          <p class="site-author-name" itemprop="name">CodeJuan</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">97</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/codejuan" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/decbug" target="_blank">twitter</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/2763396/codejuan" target="_blank">stackoverflow</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
              <a href="http://blog.decbug.com/" target="_blank">decbug</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构"><span class="nav-number">2.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进展1"><span class="nav-number">3.</span> <span class="nav-text">进展1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进展2:registry集群"><span class="nav-number">4.</span> <span class="nav-text">进展2:registry集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进展3:后端存储"><span class="nav-number">5.</span> <span class="nav-text">进展3:后端存储</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进展4：mirror"><span class="nav-number">6.</span> <span class="nav-text">进展4：mirror</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一次pull"><span class="nav-number">6.1.</span> <span class="nav-text">第一次pull</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rmi_django再次pull"><span class="nav-number">6.2.</span> <span class="nav-text">rmi django再次pull</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进展5：调通删除镜像API"><span class="nav-number">7.</span> <span class="nav-text">进展5：调通删除镜像API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#update"><span class="nav-number">7.1.</span> <span class="nav-text">update</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#enable_delete"><span class="nav-number">7.1.1.</span> <span class="nav-text">enable delete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#the_API_to_delete_image"><span class="nav-number">7.1.2.</span> <span class="nav-text">the API to delete image</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CodeJuan</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'codejuan';
      var disqus_identifier = '2016/01/12/docker_distribution_build/';
      var disqus_title = 'docker(3)-搭建registry,nginx,mirror';
      var disqus_url = 'http://blog.decbug.com/2016/01/12/docker_distribution_build/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
